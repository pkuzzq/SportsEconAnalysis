<!DOCTYPE html>
<html lang="" xml:lang="">
  <head>
    <title>体育经济分析: 原理与应用</title>
    <meta charset="utf-8" />
    <meta name="author" content="周正卿" />
    <meta name="date" content="2024-02-03" />
    <script src="libs/header-attrs/header-attrs.js"></script>
    <script src="libs/kePrint/kePrint.js"></script>
    <link href="libs/lightable/lightable.css" rel="stylesheet" />
    <link rel="stylesheet" href="xaringan-themer.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">
class: center, middle, inverse, title-slide

.title[
# 体育经济分析: 原理与应用
]
.subtitle[
## 单元4: 从相关到因果的体育经济
]
.author[
### 周正卿
]
.date[
### 03 February 2024
]

---



class: title-slide-section,center, middle, inverse

# 大纲

---
### 大纲

- Level 1
  - 一个例子
- Level 2
  - 基本概念
- Level 3
  - 具体实战

---
### 什么是计量经济学

- 计量经济学是经济学的一个分支，专注于使用数学和统计方法来测试假设、验证理论和估计模型。

- 它将理论经济学、数学和统计学的技术结合起来，旨在提供定量分析经济现象的实证证据。

- 计量经济学的核心目的是识别并量化经济变量之间的关系，以此来预测未来趋势、支持政策制定和决策过程。

---

### 计量经济学的研究框架

采用计量经济学的研究框架通常遵循以下步骤：

- **问题定义与假设提出：**(Problem Definition and Hypothesis Formulation):首先明确研究问题，并基于经济理论提出可验证的假设。这一步骤是研究的基础，它确定了研究的方向和焦点。  **Topic → Problem → Question**

- **模型构建(Model Specification )：**根据假设构建经济模型，模型通常以数学方程式的形式表示，描述变量之间的关系。模型的选择和构建依赖于理论知识和实际经验。

- **数据收集(Data Collection)：**根据模型的需要，收集相应的数据。数据可以是时间序列、横截面数据或面板数据。数据的质量和适用性对后续分析至关重要。

- **估计与测试（Estimation and Testing）：**使用统计方法对模型进行估计和假设检验。常用的估计方法包括普通最小二乘法（OLS）、最大似然估计（MLE）和广义矩估计（GMM）等。估计结果用于检验理论假设的有效性。


---

### 计量经济学的研究框架

- **模型验证与诊断（Model Validation and Diagnostic Testing ）：**通过各种统计检验和诊断方法验证模型的准确性和稳健性。这包括残差分析、异方差性测试、自相关检验等。

- **政策分析与预测（Policy Analysis and Forecasting）：**基于估计和测试结果，进行政策效果分析和经济预测。这一步骤将研究成果应用于实际经济问题和政策制定中。

- **结果解释与报告（Interpretation and Reporting）：**最后，清晰地解释研究结果，并将其撰写成报告或论文。这一步骤要求研究者以易于理解的方式传达复杂的统计和经济分析结果。

---
###应用：球队胜率与上座率

在体育经济学中，球队上座率受哪些因素影响是一个常见的问题。通过经济计量模型进行量化分析，来回答该问题：

### **第一步：理论或常识指向研究假设**
在文献综述之后，需要指出，球队的获胜比例（WPCT）可能是影响上座率（ATT）的一个重要因素（是符合理论或常识的），而且理论会指向一个基本假设：球队表现越好，吸引的观众越多，从而上座率更高


### **第二步：模型构建与可验性**
模型 `\(ATT=f(WPCT)\)` 是对这种关系的抽象表示，而进一步假设 `\(\frac{\partial ATT}{\partial WPCT} \gt 0\)` 表明，随着胜率的提高，预期上座率也会增加。


---
### 应用：球队胜率与上座率
### **第三步：总体线性模型表达是为与样本链接**
将理论模型转化为总体线性表达式 `\(ATT= \beta + \tau \times WPCT + e\)` 是为了便于使用统计方法进行估计。这里， `\(\beta\)` 是截距项， `\(\tau\)` 是你感兴趣的斜率参数（即胜率对上座率的影响）， `\(e\)` 是误差项，代表其他未观测因素的影响。

---
### 应用：球队胜率与上座率
### **第四步：参数估计与方法的限制条件**

OLS是估计线性回归模型参数的常用方法。通过最小化误差项的平方和来找到最佳拟合线，从而估计模型中的 `\(\tau\)` 
但使用OLS方法在许多假设（如误差项的同方差性和独立性）被满足的情况下，可以提供有效且一致的参数估计

- **关于估计值 `\(\hat\tau\)` 是否为真实值 `\(\tau\)` ？ **
估计值 `\(\hat\tau\)` 是基于样本数据对真实参数 `\(\tau\)` 的最佳猜测。在理想情况下，如果模型正确指定且所有OLS的假设都被满足， `\(\hat\tau\)` 会随着样本大小的增加趋向于真实值 `\(\tau\)`。但在实际应用中，可能因为**模型设定错误、样本选择偏差、遗漏变量**等问题，导致  `\(\hat\tau\)` 与 `\(\tau\)` 存在偏差。因此， `\(\hat\tau\)` 是对 `\(\tau\)` 的一个估计，它的准确性和可信度取决于模型设定的合理性和样本数据的质量。

---
### 应用：球队胜率与上座率
### **第四步：参数估计与方法的限制条件**

- 上述问题演变成计量经济学的核心任务，即.bb["识别"（identification)] &lt;br&gt;→ 涉及确定模型中的相关关系是否可以从数据中可靠地推断出来
  &lt;br&gt; → 通过与已知的标准或模型进行比较，从而确定未知参数的过程

#### **因果效应的识别过程**

- 大部分问题期盼因果结论，因此识别过程的本质就演变为能够准确区分和确定特定参数或因果效应的能力。这个过程要求研究者通过合理的**研究设计**策略来区分因果关系，而不仅仅是相关性。
- 在社会科学论文中，确立识别策略意味着**明确地指出如何使用数据和模型来估计因果效应，这通常涉及顺应研究传统、排除竞争性理论、实施自然实验等具体问题


---
### 应用：球队胜率与上座率
### **第四步：参数估计与方法的限制条件**

#### **推断是包含在识别过程中必要环节**
- 在统计学传统中，**推断**（inference）是指基于样本数据对总体参数进行估计和假设检验的过程。这相当于使用现场照片（ `\(\hat\tau\)` ）去推测数据库中的真实照片（ `\(\tau\)` ）。
- 经济学的推断不仅仅关注于统计学的显著性，还要考虑估计值的经济学意义，即它们在现实世界中的应用和重要性。

#### 区分**统计学意义**与**经济学意义**

- **统计学意义**关注的是估计结果是否不太可能是随机波动所导致的，通常通过p值、置信区间等统计测试来评估。
- **经济学意义**则更加关注估计结果的实际影响大小和方向，以及这些结果在经济理论和政策制定中的应用。


---
### 应用：球队胜率与上座率
### **第四步：参数估计与方法的限制条件**

#### **因果推断**

- 当我们说估计值 `\(\hat\tau\)` 具有**因果性**时，指的是延续科学研究中的**识别**学术传统去**推断**真实值 `\(\tau\)` 。 隐含的前提是：真实值 `\(\tau\)`  已经具有因果特质。因果推断的目标是使用观察到的数据来估计未被观察到的因果效应。
- 实现因果推断需要满足一系列假设，包括但不限于无遗漏变量偏差、稳定的单元处理值假设（SUTVA）以及潜在结果的独立性假设。

总之，识别和推断是计量经济学中最重要的概念，它们使研究者能够从数据中提取有意义的因果关系。通过理论建构、稳健性检验、排除竞争性理论等步骤，研究者可以确立他们的研究不仅在统计上显著，而且在经济上具有意义，从而为经济政策和理论提供有力的支持。


---
### 例子：球队胜率与上座率

### **第五步：结果解读与应对质疑**

.center[ ATT =-2.4536+65.23 * WPCT ]
- 估计结果能够识别胜率（WPCT）对上座率（ATT）有显著的正面影响。但是模型的解释力度（ `\(R^2=0.311\)` ）表明还有大部分变异未被模型捕捉，这引出了模型可能存在的问题和进一步改进的方向

#### .purple[质疑1: 模型的解释力度不够]

尽管胜率是上座率的一个重要因素，但显然还有其他因素影响着上座率。这导致了两个主要问题：

- 研究问题是否足够重要？ 即使胜率是一个显著的因素，但如果其他未考虑的因素对上座率有更大的影响，那么仅研究胜率可能不足以全面理解上座率的变化。
- 模型是否过度简化？ 在实际应用中，很少有单一因素能够完全解释一个经济现象。因此，模型可能需要包含更多的解释变量来提高解释力度。


---
### 例子：球队胜率与上座率

### **第五步：结果解读与应对质疑**

#### .purple[质疑 2:用估计值代替真实值是**偏误**的]

**内生性**问题通常出现在模型中的解释变量与误差项相关时。例如，市场规模和联赛差异可能同时影响胜率和上座率，如果不将这些因素纳入模型，可能会导致估计偏误。

- 控制变量的引入：通过将市场规模和联赛差异作为控制变量纳入模型（ `\(\boldsymbol{X}\beta\)` ），可以帮助减少遗漏变量偏差，提高模型估计的准确性。
  - 将总体线性表达式**修正**为 `\(ATT=\boldsymbol{X} \beta + \tau \times WPCT + e\)`
  - 市场规模与联赛差异进入了 `\(\boldsymbol{X}\beta\)`
  - 最关键的：这两个因素同时影响球队胜率和上座率。若忽略它们会导致**遗漏变量偏差**，产生所谓的**内生性**问题 → 

**内生性解决方法**：除了加入控制变量外，还可以使用工具变量等方法解决内生性问题，前提是能找到合适的工具变量。

---
### 例子：球队胜率与上座率

.center[ATT=-.421+1.174POP-2.014 LEAGUE + 59.31*WPCT
&lt;img src=https://pkuzzq-image.oss-cn-beijing.aliyuncs.com/uPic/WanJH1.png height=230&gt;]

- 那么59.31就能代表真实值了么?
- 练习：系数如何解释？具有如何意义？Dummy(AL=1) vs Continuous

---
### 经验研究的研究逻辑

![BigPicture](https://pkuzzq-image.oss-cn-beijing.aliyuncs.com/uPic/BigPicture.png)

- 观察样本(estmators) .mono[--&gt;] 客观事实(=estmands) .mono[--&gt;] 因果模型(=parameter) .mono[--&gt;] 理论知识(knowledge)
- 在本次课程中，为建立样本数据与因果推断的逻辑体系，将重点介绍两个最重要的考
  - 平衡遗漏变量与过度控制的问题 + 避免内生性问题的质疑 


---
### 从客观事实到因果模型

- **遗漏变量偏误（Omitted Variable Bias, OVB）**的讨论指出，如果重要的解释变量没有被包括在模型中，可能会导致对其他变量效应的估计产生偏误。这是因为遗漏的变量可能与模型中的变量相关，并且直接影响到结果变量。
- **过度控制问题**涉及到将那些受到干预变量影响的变量作为控制变量加入模型，这可能会干扰真实的因果关系，导致对感兴趣效应的错误估计。

#### 如何平衡
- 研究者应当根据理论知识以及对研究领域的深入理解，仔细选择控制变量。理想的控制变量应当是那些影响结果变量、与干预变量相关，但不是由干预变量决定的变量。
- 遵循**时间原则**，优先考虑那些在干预变量发生前就已确定的变量作为控制变量。这有助于减少因逆向因果或干预变量引起的变化而产生的偏误。


---
### 从客观事实到因果模型
#### 实施建议

- **理论指导**：研究设计和控制变量的选择应该基于坚实的理论基础，确保模型能够反映研究问题的本质。
- **稳健性检验**：通过稳健性检验，如使用不同的模型规格和控制变量组合，检查估计结果的稳定性。
- **考虑人的预期**：在某些研究情景下，考虑人的预期和行为对未来的预测也非常重要，这可能要求引入动态模型或使用前瞻性数据。

#### 通过教育回报率的例子具体阐释了如何实施这一过程

---
class: title-slide-section, middle, inverse
# 从客观事实到因果模型I &lt;br&gt; → 平衡遗漏变量与过度控制
---

### 经验研究的研究逻辑

&lt;br&gt;
&lt;img src="./figs/BigPicture1.png"&gt;
- 增加控制变量确实可以提高回归模型解释力，但过度控制会产生失去模型的意义&lt;br&gt; → 引入遗漏变量偏误公式工具

---
### 应用：教育回报率

- 遗漏变量偏误公式提供了一个强有力的工具，用于分析当模型遗漏了重要解释变量时，估计系数偏误的方向和大小。
- **长回归方程**和**短回归方程**。长回归方程（1）考虑了能力 `\(A_i\)` 对收入 `\(INC_i\)` 的影响，而短回归方程（2）则没有。这种简化假设可能导致对教育 `\(EDU_i\)` 的回报率 `\(\beta\)` 的估计出现偏误。

$$
`\begin{align}
  {INC}_{i} &amp;= \alpha + \tau {EDU}_i + {A}_{i}'\gamma + e_i \tag{1}
\end{align}`
$$
$$
`\begin{align}
  {INC}_{i} &amp;= \alpha + \beta {EDU}_i + v_i \tag{2}
\end{align}`
$$

  - 注意, `\(\alpha, \tau, \gamma\)` 是总体意义上的, `\(e_{i}\)` 表示扰动项。暂且假设系数 `\(\tau\)` 具有因果性，是我们最感性兴趣的

---
- **遗漏变量偏误公式 (Omitted Variable Bias Formula)**为：

--- 
$$
`\begin{align}
  \hat \beta_{ols} =\dfrac{\mathop{{Cov}} \left( {INC}_{i},\, {EDU}_i \right)}{\mathop{{Var}} \left( {EDU}_i \right)} = \tau + \gamma' \delta_{A_{EDU}}
\end{align}`
$$
- 其中, `\(\delta_{A_{EDU}}\)` 是对 `\(A_{i}\)` 关于 `\(EDU_{i}\)` 回归得到的系数

#### 解释和含义

在教育回报率的例子中，考虑能力等潜在的混杂变量对于避免偏误和错误的因果推断至关重要，要正确识别感兴趣的参数，以下条件必须满足其一：

1. 如果受教育程度与能力大小无关（ `\(\delta_{A_{EDU}} = 0\)` ），这意味着能力不会影响个体选择受教育的程度。
2. 如果在控制受教育程度后，能力大小与工资多少无关（ `\(\gamma = 0\)` ），则意味着能力对于收入的影响可以被忽略。

---
### 实际应用中的挑战

实际上，满足以上两个条件是非常困难的，因为教育程度通常与个体能力强相关，而个体的能力又显著影响其收入。

- 尽量把能力这个看不到的变量给控制住 → 找到代理变量
 
---
### 例子(MHE)

&lt;table&gt;
&lt;caption&gt;教育回报率(MHE)&lt;/caption&gt;
 &lt;thead&gt;
  &lt;tr&gt;
   &lt;th style="text-align:left;"&gt;   &lt;/th&gt;
   &lt;th style="text-align:center;"&gt; 1 &lt;/th&gt;
   &lt;th style="text-align:center;"&gt; 2 &lt;/th&gt;
   &lt;th style="text-align:center;"&gt; 3 &lt;/th&gt;
   &lt;th style="text-align:center;"&gt; 4 &lt;/th&gt;
  &lt;/tr&gt;
 &lt;/thead&gt;
&lt;tbody&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;font-weight: bold;"&gt; 教育程度 &lt;/td&gt;
   &lt;td style="text-align:center;"&gt; 0.132 &lt;/td&gt;
   &lt;td style="text-align:center;"&gt; 0.131 &lt;/td&gt;
   &lt;td style="text-align:center;"&gt; 0.114 &lt;/td&gt;
   &lt;td style="text-align:center;"&gt; 0.087 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;font-weight: bold;"&gt;  &lt;/td&gt;
   &lt;td style="text-align:center;"&gt; (0.007) &lt;/td&gt;
   &lt;td style="text-align:center;"&gt; (0.007) &lt;/td&gt;
   &lt;td style="text-align:center;"&gt; (0.007) &lt;/td&gt;
   &lt;td style="text-align:center;"&gt; (0.009) &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;font-weight: bold;"&gt; 控制变量 &lt;/td&gt;
   &lt;td style="text-align:center;"&gt; None &lt;/td&gt;
   &lt;td style="text-align:center;"&gt; Age Dum. &lt;/td&gt;
   &lt;td style="text-align:center;"&gt; 2 + Add'l &lt;/td&gt;
   &lt;td style="text-align:center;"&gt; 3 + AFQT &lt;/td&gt;
  &lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;

MHE给出了4种增加控制变量的方式，关于工资(Y)对上学年限(X)的回归（来自NLSY，美国青年纵向调查）

the regression of Y on X , regress Y on X

---
### 例子(MHE)

&lt;table&gt;
&lt;caption&gt;教育回报率(MHE)&lt;/caption&gt;
 &lt;thead&gt;
  &lt;tr&gt;
   &lt;th style="text-align:left;"&gt;   &lt;/th&gt;
   &lt;th style="text-align:center;"&gt; 1 &lt;/th&gt;
   &lt;th style="text-align:center;"&gt; 2 &lt;/th&gt;
   &lt;th style="text-align:center;"&gt; 3 &lt;/th&gt;
   &lt;th style="text-align:center;"&gt; 4 &lt;/th&gt;
  &lt;/tr&gt;
 &lt;/thead&gt;
&lt;tbody&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;font-weight: bold;"&gt; 教育程度 &lt;/td&gt;
   &lt;td style="text-align:center;color: rgba(230, 65, 115, 255) !important;"&gt; 0.132 &lt;/td&gt;
   &lt;td style="text-align:center;"&gt; 0.131 &lt;/td&gt;
   &lt;td style="text-align:center;"&gt; 0.114 &lt;/td&gt;
   &lt;td style="text-align:center;"&gt; 0.087 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;font-weight: bold;"&gt;  &lt;/td&gt;
   &lt;td style="text-align:center;color: rgba(230, 65, 115, 255) !important;"&gt; (0.007) &lt;/td&gt;
   &lt;td style="text-align:center;"&gt; (0.007) &lt;/td&gt;
   &lt;td style="text-align:center;"&gt; (0.007) &lt;/td&gt;
   &lt;td style="text-align:center;"&gt; (0.009) &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;font-weight: bold;"&gt; 控制变量 &lt;/td&gt;
   &lt;td style="text-align:center;color: rgba(230, 65, 115, 255) !important;"&gt; None &lt;/td&gt;
   &lt;td style="text-align:center;"&gt; Age Dum. &lt;/td&gt;
   &lt;td style="text-align:center;"&gt; 2 + Add'l &lt;/td&gt;
   &lt;td style="text-align:center;"&gt; 3 + AFQT &lt;/td&gt;
  &lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;

.hi[第1列] 没有控制变量 意味着每额外获得1年教育，工资有13.2%的增长。
---
### 例子(MHE)

&lt;table&gt;
&lt;caption&gt;教育回报率(MHE)&lt;/caption&gt;
 &lt;thead&gt;
  &lt;tr&gt;
   &lt;th style="text-align:left;"&gt;   &lt;/th&gt;
   &lt;th style="text-align:center;"&gt; 1 &lt;/th&gt;
   &lt;th style="text-align:center;"&gt; 2 &lt;/th&gt;
   &lt;th style="text-align:center;"&gt; 3 &lt;/th&gt;
   &lt;th style="text-align:center;"&gt; 4 &lt;/th&gt;
  &lt;/tr&gt;
 &lt;/thead&gt;
&lt;tbody&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;font-weight: bold;"&gt; 教育程度 &lt;/td&gt;
   &lt;td style="text-align:center;"&gt; 0.132 &lt;/td&gt;
   &lt;td style="text-align:center;color: rgba(230, 65, 115, 255) !important;"&gt; 0.131 &lt;/td&gt;
   &lt;td style="text-align:center;"&gt; 0.114 &lt;/td&gt;
   &lt;td style="text-align:center;"&gt; 0.087 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;font-weight: bold;"&gt;  &lt;/td&gt;
   &lt;td style="text-align:center;"&gt; (0.007) &lt;/td&gt;
   &lt;td style="text-align:center;color: rgba(230, 65, 115, 255) !important;"&gt; (0.007) &lt;/td&gt;
   &lt;td style="text-align:center;"&gt; (0.007) &lt;/td&gt;
   &lt;td style="text-align:center;"&gt; (0.009) &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;font-weight: bold;"&gt; 控制变量 &lt;/td&gt;
   &lt;td style="text-align:center;"&gt; None &lt;/td&gt;
   &lt;td style="text-align:center;color: rgba(230, 65, 115, 255) !important;"&gt; Age Dum. &lt;/td&gt;
   &lt;td style="text-align:center;"&gt; 2 + Add'l &lt;/td&gt;
   &lt;td style="text-align:center;"&gt; 3 + AFQT &lt;/td&gt;
  &lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;

.hi[第2列] 控制年龄，意味着每额外获得1年教育，工资有13.1%的增长. 
---
### 例子(MHE)

&lt;table&gt;
&lt;caption&gt;教育回报率(MHE)&lt;/caption&gt;
 &lt;thead&gt;
  &lt;tr&gt;
   &lt;th style="text-align:left;"&gt;   &lt;/th&gt;
   &lt;th style="text-align:center;"&gt; 1 &lt;/th&gt;
   &lt;th style="text-align:center;"&gt; 2 &lt;/th&gt;
   &lt;th style="text-align:center;"&gt; 3 &lt;/th&gt;
   &lt;th style="text-align:center;"&gt; 4 &lt;/th&gt;
  &lt;/tr&gt;
 &lt;/thead&gt;
&lt;tbody&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;font-weight: bold;"&gt; 教育程度 &lt;/td&gt;
   &lt;td style="text-align:center;"&gt; 0.132 &lt;/td&gt;
   &lt;td style="text-align:center;"&gt; 0.131 &lt;/td&gt;
   &lt;td style="text-align:center;color: rgba(230, 65, 115, 255) !important;"&gt; 0.114 &lt;/td&gt;
   &lt;td style="text-align:center;"&gt; 0.087 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;font-weight: bold;"&gt;  &lt;/td&gt;
   &lt;td style="text-align:center;"&gt; (0.007) &lt;/td&gt;
   &lt;td style="text-align:center;"&gt; (0.007) &lt;/td&gt;
   &lt;td style="text-align:center;color: rgba(230, 65, 115, 255) !important;"&gt; (0.007) &lt;/td&gt;
   &lt;td style="text-align:center;"&gt; (0.009) &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;font-weight: bold;"&gt; 控制变量 &lt;/td&gt;
   &lt;td style="text-align:center;"&gt; None &lt;/td&gt;
   &lt;td style="text-align:center;"&gt; Age Dum. &lt;/td&gt;
   &lt;td style="text-align:center;color: rgba(230, 65, 115, 255) !important;"&gt; 2 + Add'l &lt;/td&gt;
   &lt;td style="text-align:center;"&gt; 3 + AFQT &lt;/td&gt;
  &lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;

.hi[第3列] ，第2列控制变量再加上父母教育和自身人口学特征， 意味着每额外获得1年教育，工资有11.4%的增长。
---
### 例子(MHE)

&lt;table&gt;
&lt;caption&gt;教育回报率(MHE)&lt;/caption&gt;
 &lt;thead&gt;
  &lt;tr&gt;
   &lt;th style="text-align:left;"&gt;   &lt;/th&gt;
   &lt;th style="text-align:center;"&gt; 1 &lt;/th&gt;
   &lt;th style="text-align:center;"&gt; 2 &lt;/th&gt;
   &lt;th style="text-align:center;"&gt; 3 &lt;/th&gt;
   &lt;th style="text-align:center;"&gt; 4 &lt;/th&gt;
  &lt;/tr&gt;
 &lt;/thead&gt;
&lt;tbody&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;font-weight: bold;"&gt; 教育程度 &lt;/td&gt;
   &lt;td style="text-align:center;"&gt; 0.132 &lt;/td&gt;
   &lt;td style="text-align:center;"&gt; 0.131 &lt;/td&gt;
   &lt;td style="text-align:center;"&gt; 0.114 &lt;/td&gt;
   &lt;td style="text-align:center;color: rgba(230, 65, 115, 255) !important;"&gt; 0.087 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;font-weight: bold;"&gt;  &lt;/td&gt;
   &lt;td style="text-align:center;"&gt; (0.007) &lt;/td&gt;
   &lt;td style="text-align:center;"&gt; (0.007) &lt;/td&gt;
   &lt;td style="text-align:center;"&gt; (0.007) &lt;/td&gt;
   &lt;td style="text-align:center;color: rgba(230, 65, 115, 255) !important;"&gt; (0.009) &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;font-weight: bold;"&gt; 控制变量 &lt;/td&gt;
   &lt;td style="text-align:center;"&gt; None &lt;/td&gt;
   &lt;td style="text-align:center;"&gt; Age Dum. &lt;/td&gt;
   &lt;td style="text-align:center;"&gt; 2 + Add'l &lt;/td&gt;
   &lt;td style="text-align:center;color: rgba(230, 65, 115, 255) !important;"&gt; 3 + AFQT &lt;/td&gt;
  &lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;

- .hi[第4列] (第3列又控制 AFQT.super[.pink[†]] 分数) 意味着每额外获得1年教育，工资有8.7%的增长。 

.footnote[.pink[†] 武装部队资格测验（AFQT）是美国军队招募的基本资格测验。它是由美国国防部于1950年开发的一个筛查测试，用于评估一个人是否符合入伍资格。]
---
### 例子(MHE)

&lt;table&gt;
&lt;caption&gt;教育回报率(MHE)&lt;/caption&gt;
 &lt;thead&gt;
  &lt;tr&gt;
   &lt;th style="text-align:left;"&gt;   &lt;/th&gt;
   &lt;th style="text-align:center;"&gt; 1 &lt;/th&gt;
   &lt;th style="text-align:center;"&gt; 2 &lt;/th&gt;
   &lt;th style="text-align:center;"&gt; 3 &lt;/th&gt;
   &lt;th style="text-align:center;"&gt; 4 &lt;/th&gt;
  &lt;/tr&gt;
 &lt;/thead&gt;
&lt;tbody&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;font-weight: bold;"&gt; 教育程度 &lt;/td&gt;
   &lt;td style="text-align:center;color: rgba(106, 90, 205, 255) !important;"&gt; 0.132 &lt;/td&gt;
   &lt;td style="text-align:center;"&gt; 0.131 &lt;/td&gt;
   &lt;td style="text-align:center;"&gt; 0.114 &lt;/td&gt;
   &lt;td style="text-align:center;color: rgba(230, 65, 115, 255) !important;"&gt; 0.087 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;font-weight: bold;"&gt;  &lt;/td&gt;
   &lt;td style="text-align:center;color: rgba(106, 90, 205, 255) !important;"&gt; (0.007) &lt;/td&gt;
   &lt;td style="text-align:center;"&gt; (0.007) &lt;/td&gt;
   &lt;td style="text-align:center;"&gt; (0.007) &lt;/td&gt;
   &lt;td style="text-align:center;color: rgba(230, 65, 115, 255) !important;"&gt; (0.009) &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;font-weight: bold;"&gt; 控制变量 &lt;/td&gt;
   &lt;td style="text-align:center;color: rgba(106, 90, 205, 255) !important;"&gt; None &lt;/td&gt;
   &lt;td style="text-align:center;"&gt; Age Dum. &lt;/td&gt;
   &lt;td style="text-align:center;"&gt; 2 + Add'l &lt;/td&gt;
   &lt;td style="text-align:center;color: rgba(230, 65, 115, 255) !important;"&gt; 3 + AFQT &lt;/td&gt;
  &lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;

- 可以看到，随着控制变量的增加，从.hi-purple[第1列]到.hi[第4列]教育回报率估计值下降了4.5个百分点（系数下降34%）。

$$
`\begin{align}
  \color{#6A5ACD}{\dfrac{\mathop{{Cov}} \left( {INC}_{i},\, {EDU}_i \right)}{\mathop{{Var}} \left( {EDU}_i \right)}} = \color{#e64173}{\tau} + \color{#20B2AA}{\gamma'} \color{#FFA500}{\delta_{A_{EDU}}}
\end{align}`
$$

- .hi[讨论] 为什么？

---
### 遗漏变量偏误公式

- OVB公式**并不**要求每一个回归模型都能正确识别因果关系。该公式比较了.hi-purple[短模型]中的回归系数和.hi-pink[长模型]中同一变量的回归系数 → 降低了误判的可能性

- `\(\tau\)` 是否因果还应该有其他的假设：**条件独立假设** → 更理想的方式是RCT

$$
`\begin{align}
  \color{#6A5ACD}{\dfrac{\mathop{{Cov}} \left( {Y}_{i},\, {x}_i \right)}{\mathop{{Var}} \left( {x}_i \right)}} = \color{#e64173}{\tau} + \color{#20B2AA}{\gamma'} \color{#FFA500}{\delta_{Omitted-x_i}}
\end{align}`
$$


### 加入坏的控制变量 → 过度控制问题

- 在加入控制变量时，选择哪些变量进行控制至关重要。理想的控制变量应该是那些与处理变量和潜在结果都相关，但不是由干预变量引起的变量。
- 不良控制变量，如个人职业和就业行业，在教育研究中可能不适合作为控制变量，因为这些变量可能是教育的结果而非原因。控制这些变量可能引入过度控制问题，从而掩盖教育对收入的真实影响。
- 控制变量的选择应基于理论和先前的研究，确保这些变量不是处理变量引起的。此外，也需要考虑到变量之间可能存在的动态关系和因果路径

???
- 因为个人职业及就业行业往往是教育完成之后个人选择的结果，也就是说，这些变量发生在教育之后，可能受到教育的影响。
- 事实上，教育对职业选择有重要影响，职业和行业往往存在着密切的联系

---
### 例子(MHE)

&lt;table&gt;
&lt;caption&gt;表 3.2.1  教育回报率(MHE)&lt;/caption&gt;
 &lt;thead&gt;
  &lt;tr&gt;
   &lt;th style="text-align:left;"&gt;   &lt;/th&gt;
   &lt;th style="text-align:center;"&gt; 1 &lt;/th&gt;
   &lt;th style="text-align:center;"&gt; 2 &lt;/th&gt;
   &lt;th style="text-align:center;"&gt; 3 &lt;/th&gt;
   &lt;th style="text-align:center;"&gt; 4 &lt;/th&gt;
   &lt;th style="text-align:center;"&gt; 5 &lt;/th&gt;
  &lt;/tr&gt;
 &lt;/thead&gt;
&lt;tbody&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;font-weight: bold;"&gt; 教育程度 &lt;/td&gt;
   &lt;td style="text-align:center;"&gt; 0.132 &lt;/td&gt;
   &lt;td style="text-align:center;"&gt; 0.131 &lt;/td&gt;
   &lt;td style="text-align:center;"&gt; 0.114 &lt;/td&gt;
   &lt;td style="text-align:center;"&gt; 0.087 &lt;/td&gt;
   &lt;td style="text-align:center;color: rgba(230, 65, 115, 255) !important;"&gt; 0.066 &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;font-weight: bold;"&gt;  &lt;/td&gt;
   &lt;td style="text-align:center;"&gt; (0.007) &lt;/td&gt;
   &lt;td style="text-align:center;"&gt; (0.007) &lt;/td&gt;
   &lt;td style="text-align:center;"&gt; (0.007) &lt;/td&gt;
   &lt;td style="text-align:center;"&gt; (0.009) &lt;/td&gt;
   &lt;td style="text-align:center;color: rgba(230, 65, 115, 255) !important;"&gt; (0.010) &lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
   &lt;td style="text-align:left;font-weight: bold;"&gt; 控制变量 &lt;/td&gt;
   &lt;td style="text-align:center;"&gt; None &lt;/td&gt;
   &lt;td style="text-align:center;"&gt; Age Dum. &lt;/td&gt;
   &lt;td style="text-align:center;"&gt; 2 + Add'l &lt;/td&gt;
   &lt;td style="text-align:center;"&gt; 3 + AFQT &lt;/td&gt;
   &lt;td style="text-align:center;color: rgba(230, 65, 115, 255) !important;"&gt; 4 + Occupation &lt;/td&gt;
  &lt;/tr&gt;
&lt;/tbody&gt;
&lt;/table&gt;

- .hi[第5列]，再控制职业。我们如何解释新的结果？
--

&lt;br&gt;&lt;br&gt;
教育水平的系数变小可能仅仅是(过度控制导致的)**选择偏误**表现

---
### 如何选择控制变量

1. **理论指导**：控制变量的选择应该由相关理论和以往研究来指导。理论框架可以帮助识别可能影响研究结果的关键变量。
2. **先前研究**：查阅相关文献，了解在相似研究背景下哪些变量被控制，可以提供有价值的参考。
3. **与干预和结果相关**：选择与干预变量（例如，受教育程度）和潜在结果（例如，收入）都相关，但不是由处理变量直接引起的变量。
4. **避免结果变量**：避免使用可能是干预变量结果的变量作为控制变量，因为这可能引入过度控制问题。
5. **数据可得性**：在实际研究中，控制变量的选择还受限于数据的可得性。选择可靠和准确测量的变量。

---
### 避免过度控制问题

1. **识别中介变量**：中介变量是介于干预变量和结果变量之间的变量，干预变量通过中介变量影响结果变量。在分析中控制中介变量可能会屏蔽干预变量的部分或全部效应。
2. **考虑变量的时间顺序**：理想的控制变量应该是在干预变量发生之前就已经确定的变量。这有助于保证控制变量不是由干预变量引起的。
3. **动态关系和因果路径**：在选择控制变量时，考虑变量之间的动态关系和可能的因果路径。理解变量之间是如何相互作用的，可以帮助避免不当的控制变量选择。
4. **稳健性检验**：通过进行一系列稳健性检验，如在模型中逐步加入或移除控制变量，可以评估控制变量选择对估计结果的影响。

---
class: title-slide-section,inverse, middle
# 从客观事实到因果模型II&lt;br&gt; → 避免内生性问题

---

- 内生性问题通常源于三个个主要因素：遗漏变量、测量误差和互为因果。
- 如果干扰项 `\(e\)` 和干预变量 `\(X_i\)` 是相关的，那么我们称这个模型存在内生性问题。

### 内生性问题的影响

- **严重问题**：如果没有清楚指出解释变量与因变量之间的因果关系，可能会被学术期刊拒稿。
- **轻微问题**：如果无法在可信的水平下控制内生性问题，可能无法发表在顶级期刊。

---
### 测量误差对教育回报率估计的影响
(1) 教育存在测量误差

如果我们在测量教育水平时存在误差，比如受访者报告的受教育年数不准确，
比如可能忘记了准确的学习年限，或者在提供信息时夸大或缩小了数字：

 `$$y_{i}=\beta_{0}+\beta_{1} x_{1 i}+u_{i}$$` 

这里， `\(y_i\)` 是个体 `\(i\)` 的收入， `\(x_{1i}\)` 是受教育年数， `\(u_i\)` 是模型中的随机干扰项。

但是，如果我们实际观察到的教育年数 `\(x_{1i}^{obs}\)` 包含了一些误差 `\(v_i\)`：

`$$x_{1 i}^{obs}=x_{1 i}+v_{i}$$`

那么我们实际估计的模型将变为：

`$$y_{i}=\beta_{0}+\beta_{1} x_{1 i}^{obs}+e_{i}$$`

这里的 `\(e_{i}=\left(u_{i}-\beta_{1} v_{i}\right)\)` 是新的干扰项，它包含了原始干扰项 `\(u_i\)` 和由于测量误差 `\(v_i\)` 引入的额外误差。

---
### 测量误差对教育回报率估计的影响

测量误差导致的主要问题是，我们试图估计的教育对收入影响的系数 `\(\beta_{1}\)` 会受到影响：

`$$plim \hat{\beta}_{1}^{OLS} =\beta_{1}\left(\frac{\sigma_{x_{1}}^{2}}{\sigma_{x_{1}}^{2}+\sigma_{v}^{2}}\right)$$`

这意味着，由于存在测量误差，我们估计的教育对收入影响的系数 `\(\hat{\beta}_{1}^{OLS}\)` 将会比真实的影响 `\(\beta_{1}\)` 小。这种现象被称为衰减偏误（attenuation bias），它使得我们低估了教育对收入的真实影响。

在该例子，对教育的测量无论是系统性夸大还是低报，**估计系数都会是真实值的下限**。


---

### 测量误差对教育回报率估计的影响
(2) 收入存在测量误差
如果接受调查的个人选择瞒报、乱说收入，这意味这测量误差与收入多少和教育程度都没有关系 → 收入与教育估计上是没有相关性的

- 尽管结果变量的测量误差不会直接引起内生性问题，但使得相关性在统计学意义不成立了，这意味可能更难以在统计上发现变量之间的真实关系。

---
### 互为因果

.less-right[ 
- Charles F. Manski
 在1993年的论文中，深入探讨了内生社会效应的识别问题，90年代初期社会科学对个体行为和群体行为相互作用的兴趣日增
- 曼斯基的工作是在这一时期对社会互动效应进行量化和识别方法论的重要贡献之一]

.more-left[
&lt;img src = https://pkuzzq-image.oss-cn-beijing.aliyuncs.com/uPic/zTXjeS.png &gt;
]


---
### 互为因果
论文中提出的模型可以表述为：

$$
`\begin{aligned}
Y &amp; =\underbrace{\beta E(Y \mid g)}_{\text {endogeneous }}+\underbrace{\gamma_1 E(X \mid g)}_{\text {exogeneous }}+\gamma_2 X  +\underbrace{\gamma_3 g}_{\text {contextual }}+u
\end{aligned}`
$$

这里， `\(Y\)` 是个体的行为或结果变量， `\(X\)` 是解释变量（可以是个体的特征或行为）， `\(g\)` 代表个体所在的群体（如班级、俱乐部等）， `\(E(Y|g)\)` 和 `\(E(X|g)\)` 分别表示在群体 `\(g\)` 内个体行为 `\(Y\)` 和解释变量 `\(X\)` 的平均水平。
- 模型的参数 `\(\beta\)` 、 `\(\gamma_1\)` 、 `\(\gamma_2\)` 和 `\(\gamma_3\)` 代表不同的效应，其中 `\(\beta\)` 是内生效应参数，表示个体行为如何受到群体行为平均水平的影响； `\(\gamma_1\)`  和 `\(\gamma_2\)` 是解释变量的外生效应参数； `\(\gamma_3\)` 是群体特征的影响； `\(u\)` 是误差项。
- "同伴"（Peers）的定义往往不是很明确，但通常指的是如班级、俱乐部等具有共同特征或共同目标的群体。群体成员可能在年龄、兴趣、地理位置或社会经济地位等方面具有相似性。在分析同伴效应时，研究人员关注的是这些群体内部成员间的相互作用及其对个体行为、态度或成就的影响。
- 在教育回报率中，同伴效应指学生在班级环境中相互影响的过程，对个体行为的影响

---
### 互为因果
曼斯基关注的一个关键问题是群体中的同伴（peers）效应，并指出在实证研究中通常难以明确定义什么是同伴群体。尽管同伴群体通常是指如班级、俱乐部这样的集体，但这些群体的边界和构成在现实世界中可能并不清晰。

进一步，曼斯基展开了模型的简约形式（Reduced Form, RF）：

$$
`\begin{aligned}
Y &amp; =\gamma_1 /(1-\beta) E(X \mid g)+\left(\gamma_2 /(1-\beta)\right) X +\left(\gamma_3 /(1-\beta)\right) g+\tilde{u}
\end{aligned}`
$$

该方程形式揭示的是：在考虑内生的社会效应时，个体行为 `\(Y\)` 如何受到个体特征 `\(X\)` 、同伴效应 `\(E(X|g)\)` 和群体特征 `\(g\)` 的综合影响。通过这种形式，曼斯基试图提供一种方法来估计内生社会效应的大小，同时指出在存在内生性时进行准确估计的困难。

曼斯基的这篇论文为理解和分析社会互动效应提供了一个重要的理论框架，同时也指出了在实际应用这些模型时面临的挑战，特别是如何准确识别和量化这些效应。这项工作对后来的研究产生了深远的影响，促进了对社会互动和个体决策之间复杂关系更深入的理解和分析。

---

class: title-slide-section,inverse, middle
## 小结: 偏误类型与解决办法

---
### 有向无环图

.pull-left[

- .hi.pink[教育回报率]
- 根据理论将总体模型设定为： `\(INC = \alpha + \beta_1 EDU + \beta_2 IQ + e\)` 

&lt;img src=https://pkuzzq-image.oss-cn-beijing.aliyuncs.com/uPic/drGBU8.png &gt;
]

.pull-right[
- **有向无环图**(directed acyclic graph)
- 实心-可观测；空心-不可观测；单向箭头-因果关系；无法递归
- EDU .mono[-&gt;] INC 直接因果路径
- EDU .mono[&lt;-] IQ .mono[-&gt;] INC 混淆路径1
- EDU .mono[&lt;-] e  .mono[-&gt;] INC 混淆路径2
- 右图：干扰项条件均值独立于干预变量
- 左图：即便控制了IQ无效
]

---
### 偏回归系数

- 对于LPF： `\(INC = \alpha + \beta_1 EDU + \beta_2 IQ + e\)`  
- 两边取条件期望, 得到对应的线性CEF:
$$
`\begin{aligned}
&amp;{E}(I N C \mid E D U, I Q) \\
&amp;=\alpha+\beta_{1} E D U+\beta_{2} I Q+{E}(e \mid E D U, I Q) \\
&amp;=\alpha+\beta_{1} E D U+\beta_{2} I Q
\end{aligned}`
$$
- 对EDU求偏导：**偏回归系数**
$$
\frac{d {E}(INC \mid EDU, IQ)}{d EDU}=\beta_{1}
$$

`\(\beta_{1}\)` 表示在IQ固定不变，INC 的期望值（均值）随 EDU 如何变化


---
### 有向无环图表达偏误类型

  - 因果路径
  - 混淆路径: A .mono[&lt;-] B .mono[-&gt;] C , B是A和C的混淆变量；混淆变量会产生相关关系 → 必须控制 
  - 对撞路径: A .mono[-&gt;] B .mono[&lt;-] C , B是A和C的对撞变量；对撞变量不会产生相关性，但若错误地控制了就会产生相关关系

- 估计X与Y的因果关系的本质是找到二者间所有的因果路径，同时排除二者间所有非因果关系路径

---
### 混淆偏误（好的控制）

- 混淆偏误是指在X和Y之间存在未截断的混淆路径，造成X和Y的相关性不仅包含因果关系，还包含非因果关系

- 截断混淆路径是通过给定混淆变量（conditional on confounding variable）为条件，从而排除混淆变量的干扰。给定混淆变量可以简单的理解为固定混淆变量的值。在关系图中，我们加个方框表示这个变量是给定的

- 当混淆变量给定时，X和Y的相关性就与混淆变量无关，二者相关性就是因果关系

.center[
![H1mMrc](https://pkuzzq-image.oss-cn-beijing.aliyuncs.com/uPic/H1mMrc.png)
]

---
### 过度控制偏误

- 过度控制偏误是指控制了因果路径上的变量造成的偏误

- 在研究中我们要避免控制受X影响并会影响Y的中介变量，否则会造成过度控制偏差
&lt;br&gt;&lt;br&gt;&lt;br&gt;
.center[
![gVegRq](https://pkuzzq-image.oss-cn-beijing.aliyuncs.com/uPic/gVegRq.png)
.center[.cap[图：过度控制偏差]]
]

- 控制了生活规律，就截断了一条因果路径，估计得到的只是锻炼对健康的直接因果关系，相当于**低估**真实值

---
### 对撞偏误

- 对撞偏误可以理解为当给定两个变量的共同结果（对撞变量） 时（或者对撞变量的延伸结果变量），两个变量间会产生一个衍生路径。 衍生路径会造成两个原本不相关的变量变为相关，或造成两个原本相关 的变量的相关性发生改变。
&lt;br&gt;&lt;br&gt;&lt;br&gt;
.center[
![Uldp6M](https://pkuzzq-image.oss-cn-beijing.aliyuncs.com/uPic/Uldp6M.png).center[.cap[图：对撞偏误]]
]
---
### 对撞偏误

.center[
&lt;img src="https://pkuzzq-image.oss-cn-beijing.aliyuncs.com/uPic/0lB77J.png" height="200"&gt;
]
.center[
&lt;img src="https://pkuzzq-image.oss-cn-beijing.aliyuncs.com/uPic/tCw3Dn.png" height="200"&gt;
]

---
### 偏误的解决办法
在面对社会科学研究中的偏误时，我们可以采取一系列步骤来识别和解决这些问题。这些步骤包括：

1. 深入了解数据生成过程
2. 寻找偏误的潜在来源
3. 建立有向无环图 (DAG)
4. 寻找对应的解决办法

---
### 教育回报率的例子

考虑一个简单的案例，我们想要估计教育对收入的影响：

- 假设我们最初通过下面线性总体模型 (LPF) 来估计教育的效应：
 `$$INC_{it} = \alpha + \beta_{1} EDU_{it} + \varepsilon_{it}$$`

- 当可观测变量（如性别、年龄）和不可观测变量同时进入误差项 `\(\varepsilon_{it}\)` 时，导致我们无法准确识别因果影响系数 `\(\beta\)`：

.center[
&lt;img src =https://pkuzzq-image.oss-cn-beijing.aliyuncs.com/uPic/AxVxif.png&gt;
]
*将性别和年龄作为控制变量加入模型中，可以帮助我们更准确地估计教育对收入的影响*

---
### 解决办法

为了解决这个问题，我们可以将误差项 `\(\varepsilon_{it}\)` 中的可观测变量分离出来进行控制：

- 通过将年龄和性别作为控制变量纳入模型，我们可以得到改进的模型：
`$$INC_{it} = \alpha + \beta_{1} EDU_{it} + \beta_{2} AGE_{it} + \beta_{3} GENDER_{i} + e_{it}$$`

- 这样， `\(e_{it}\)`  就只包含不可观测的变量（如个性和竞争意识），从而帮助我们更准确地估计教育的真实效应。
- `\(A G E_{i t}\)` 和 `\(E D U_{i t}\)` 为时变变量； `\(G E N D E R_{i}\)` 为非时变变量（虚拟变量、类别变量）

.center[
![DlOEnk](https://pkuzzq-image.oss-cn-beijing.aliyuncs.com/uPic/DlOEnk.png)
]
---
### 例子：解决办法
在面对复杂的因果关系时，特别是当结果变量与干预变量可能存在互为因果的关系时，我们需要采取更精细化的方法来识别和估计因果效应。

#### 进一步分解误差项

一个有效的策略是将误差项 `\(\varepsilon_{it}\)` 进一步分解为不可观测的非时变变量 `\(\alpha_i\)` 和不可观测的时变变量 `\(u_{it}\)` ，即：

`$$INC_{it} = \alpha + \beta_{1} EDU_{it} + \beta_{2} AGE_{it} + \beta_{3} GENDER_{i} + \alpha_{i} + u_{it}$$`

这样做的目的是尝试隔离和控制那些可能导致偏误的不可观测因素。


---
#### 控制不可观测的非时变变量

- 如果我们认为混淆路径主要是由 `\(\alpha_i\)` 造成的，那么我们可以通过控制 `\(\alpha_i\)` 来截断这些混淆路径。
- 面板数据分析法提供了一种有效的方式来达成这一目标，通过考虑数据中的时间维度来控制不可观测的非时变变量。


.center[

![](https://pkuzzq-image.oss-cn-beijing.aliyuncs.com/uPic/IGD9bh.png)
]

---
在社会科学研究中，尤其是在处理可能存在内生性问题的情形时，分离可观测和不可观测变量对于确保因果推断的准确性至关重要。然而，实际上，很难直接在误差项 `\(\varepsilon_{it}\)` 中区分这两类变量。这就需要我们采取一些特别的方法来解决这个问题，其中引入工具变量 `\(Z_i\)` 是一种有效的策略。

#### 引入工具变量

工具变量 `\(Z_i\)` 的引入旨在帮助分解干预变量$EDU_{it}$中与误差项$e_{it}$无关的部分，即：

`$$EDU_{it} = \widehat{EDU_{it}} + v_{it}$$`

这里的 `\(\widehat{EDU_{it}}\)` 表示 `\(EDU_{it}\)` 中与 `\(e_{it}\)` 无关的部分，而 `\(v_{it}\)` 则是剩余的部分，可能与 `\(e_{it}\)` 相关。通过这种分解，我们能够更清晰地识别出 `\(EDU_{it}\)` 对结果变量 `\(Y\)` 的影响，而不被 `\(e_{it}\)` 的混淆所影响。


---
#### 引入工具变量
工具变量需要满足两个主要条件：

1. **外生性**：工具变量 `\(Z_i\)` 必须与误差项 `\(e_{it}\)` 无关，这意味着它不受模型中未观察到的变量的影响。
2. **相关性**：工具变量 `\(Z_i\)` 必须与干预变量 `\(EDU_{it}\)` 有统计上的相关性，但这种相关性不通过误差项 `\(e_{it}\)` 产生。

.center[
&lt;img src="https://pkuzzq-image.oss-cn-beijing.aliyuncs.com/uPic/t36Yi3.png" height="220"&gt;
]
---
### 选择偏误（Selection Bias）

指在选择研究样本的过程中由于非随机选择导致的研究结果系统性偏差。选择偏误可以以多种形式出现，主要包括以下几种：

1. **自我选择偏误（Self-Selection Bias）**：
   发生在研究参与者能够自主决定是否参加研究的情况下。参与者的选择是主动的，基于他们自己的特征、偏好或行为。这导致了参与研究的样本可能在某些关键特征上与那些选择不参与的个体有显著差异
2. **样本选择偏误（Sample-Selection Bias）**：发生在从总体中选择样本的过程中由于非随机选择而引起的偏差。主要特点是选择过程受到某种机制的影响，导致最终的样本不能准确反映整个总体的特性：研究设计的限制、数据收集方法等问题导致某些观测值更容易被包括或排除在样本之外
  - 假设想评估某种培训或教育对个体收入的影响。然而，如果我们的样本仅仅包括了选择参加工作的个体，那么我们的样本并不是从总体随机抽取的。这种情况下，选择参加工作的决定（由"Utility"变量表示）可能与个体的教育水平和其他未观察到的因素（如个人能力、动机等）有关，从而导致样本中的干预变量（如教育水平）和不可观测因素 `\(e\)` 之间存在相关性。这种情况下，就是因样本选择产生了**对撞偏误**（collider bias）

---
#### 解决方法
.center[
&lt;img src=https://pkuzzq-image.oss-cn-beijing.aliyuncs.com/uPic/EEzLAW.png height=220&gt;
]

- 尽管两者都会影响研究结果的代表性和准确性，但解决这两种偏误的策略可能不同。
- **自我选择偏误**，可能需要采用如 **使用倾向得分匹配**通过估计个体选择参加工作的概率（倾向得分），然后在选择参加工作和未选择参加工作的个体之间进行匹配，以创建一个在观察到的协变量上平衡的样本
- **样本选择偏误**，需要设计更加周密的抽样方案或统计方法来调整选择过程中的偏差：
  - **采用Heckman两步法**。第一步使用一个选择方程来建模个体选择参加工作的决策，然后在第二步的收入方程中加入从第一步得到的逆米尔斯比率（Inverse Mills Ratio）作为控制变量，以纠正选择偏差

---
### 解决办法小结

&lt;br&gt;&lt;br&gt;&lt;br&gt;
![MpdV2x](https://pkuzzq-image.oss-cn-beijing.aliyuncs.com/uPic/MpdV2x.png)
&lt;br&gt;


---
class: title-slide-section,inverse, middle
# 从观测样本到客观事实 &lt;br&gt; → 避免 Garbage in, Garbage out

---

### 理论、总体分布与样本

&lt;br&gt;

&lt;img src="./figs/BigPicture3.png"&gt;

---
### 假设检验和统计推断

是统计学中两个基本且互相关联的概念。它们共同构成了科学研究中推断总体参数的基础

### 假设检验
- 假设检验是一种统计方法，用于判断样本数据是否支持对总体参数的某个假设。通常涉及两个假设：零假设（ `\(H_0\)` ）和备择假设（ `\(H_1\)` ）
- 零假设通常表示为没有效应或没有差异，而备择假设表示有效应或有差异。

#### 步骤：
- 设定零假设和备择假设。
- 选择合适的检验统计量。
- 确定显著性水平（通常是0.05）。
- 根据样本数据计算检验统计量和p值。
- 根据p值决定是否拒绝零假设。

---
### 假设检验和统计推断
### 统计推断

在进行经济学或社会科学研究时，我们经常面临从样本数据中推断总体特征的需求。统计推断提供了一种方法，让我们能够基于样本信息来估计和推断总体参数（如平均值、比例或回归系数等），并评估这些估计的可靠性。

- 统计推断的目标是基于样本数据对总体进行可靠的推断
- 点估计：提供一个单一的数值作为总体参数的估计
- 区间估计：提供一个区间，预计总体参数会落在这个区间内。最常见的是置信区间
---
### 假设检验和统计推断
### 统计推断
#### 线性投影模型（LPF）

在引入统计推断的背景下，我们通常从一个确定的模型开始，如线性投影模型
(LPF)，它假设一个变量（比如个体收入Y）可以通过一组其他变量 (X) 的线性组合来预测, 同时考虑到一个误差项(e), 这个误差项代表了除 `\(X\)` 之外的其他所有影响Y的因素
$$
Y=X^{\prime} \beta+e, \quad E(e \mid X)=0
$$
目标是使用最小二乘法 (OLS) 来估计模型中的系数 `\(\beta\)`, 这些系数告诉我们变量 $X $ 如何线性影响变量 `\(Y\)` 

---
### 统计推断的关键

为了进行有效的统计推断，我们需要理解样本估计值与总体真值之间的关系。

- 大样本理论告诉我们，随着样本量的增加，通过样本计算得到的系数估计值会越来越接近总体真实的系数值。
  - **样本量**：在n&gt;200，样本估计值 `\(\hat{\beta}\)` 是总体估计值(真实值)的 `\({\beta}\)` 的一致估计( `\(\operatorname{plim} \hat{\beta}=\beta\)`)

- 标准误差给出了估计值可能的变异范围
  - 较小的标准误差意味着我们的估计值更加接近总体真实值

---
### 功效分析

除了经济领域注重识别过程外，通常研究者会进行功效分析来确定在**预期效应大小**和所选**显著性水平**下，达到足够统计功效所需的**最小样本量**。这有助于确保研究设计可以有效地检测到感兴趣的效应，同时控制研究的成本和可行性。

### 统计功效

以教育回报为例：为确保研究设计拥有足够的统计功效，即：假如教育真的对收入有显著影响，我们能够检测到这一点。反之，我们的研究设计没有足够的统计功效，那么我们可能会错误地得出教育对收入无显著影响的结论
- 这就好比我们试图听到远处的轻声细语，但周围的噪音太大，我们的“听力”（即统计功效）不足以分辨出那些微弱的声音


---
### 样本大小

- 样本大小起到了决定性作用。
- 如果我们只调查了很少数的毕业生，那么得出的结论可能会因为样本太小而不具代表性
  - 试图通过观察一个小村庄的天气来推断整个国家的气候一样不可靠。增加样本大小，相当于增加了研究“听力”，让我们更有可能准确捕捉到教育对收入的影响

### 显著性水平

- 显著性水平决定了我们愿意接受多大风险，错误地拒绝零假设（事实是没有效应，但拒绝了）
  - 设定显著性水平，就像是设置一个“听力测试”的通过标准，决定了什么样的结果我们才认为是显著的
  - 如果我们设置的显著性水平过于严格（例如α=0.01），那么我们可能错过一些真正的效应，因为我们要求的证据过于强硬
  - 相反，如果显著性水平过于宽松（例如α=0.10），我们可能会错误地认为教育对收入有显著影响，尽管实际上这种影响可能只是随机变化的结果。


---
### 教育回报率的情景化例子

- 想象我们正在研究一个大型的数据集，包括成千上万的个人，旨在分析高等教育对个人收入的影响。
- 我们决定设置显著性水平为0.05，意味着我们愿意接受5%的错误拒绝真实无效果的零假设的风险
- 通过计算得知，为了确保80%的统计功效能够检测到教育对收入的最小显著影响，我们需要至少1000名参与者的数据
- 通过这种设计，如果我们发现高等教育与收入增加之间有显著的相关性，就可以相对自信地说，这种关系不太可能是偶然发现的。
  - 这就好比我们通过大量数据和合理的“听力测试”标准，准确地听到了教育对收入提升这一细微却重要的“声音”

---
### 第I型错误（False Positive）→ 设定显著性水平 `\(\alpha\)`

- 第I型错误，或称为假阳性，发生在错误地拒绝了一个实际为真的零假设。假设正在研究是否更高的教育水平会导致更高的收入。零假设（ `\(H_0\)` ）是教育水平不影响收入，即教育回报率为零。如果实际上教育并不影响收入，但的研究错误地得出“教育水平提高了收入”的结论，那么就犯了第一型错误。
- 想象这就像是误判一位无辜的人有罪。设置的显著性水平（比如5%或0.05）就是愿意接受犯第一型错误的最大概率。

### 第II型错误（False Negative）→ 统计功效 `\(1- \beta\)`

- 第II型错误，或称为假阴性，发生在错误地没有拒绝一个实际为假的零假设。还是以教育和收入的研究为例，如果实际上更高的教育水平确实能显著提高收入，但的研究未能检测到这种影响，那么就犯了第二型错误。
- 这就像是误判一位有罪的人无辜。统计功效衡量正确发现实际效应（如果存在的话）的能力。功效越高，越有可能正确地识别出教育对收入有显著正面影响（如果真的有的话）。功效受多种因素影响，包括样本大小、效应大小、显著性水平和数据的变异性。提高样本量、增加效应大小或接受更高的第一型错误风险都可以增加统计功效。

---

class:center,middle

.pull-left[&lt;img src="figs/power.jpg"&gt;
.tiny[Type I error (significance level，P-value)、 statistical power(sensitivity)、expected effect size、sample size]]


.pull-right[&lt;img src="figs/pregnant.jpg"&gt;]

---
- **统计功效与样本大小**：在其他条件不变的情况下，样本大小增加会增加统计功效，使研究更有可能检测到实际存在的效应。
- **统计功效与显著性水平**：在样本大小固定的情况下，降低显著性水平（设置更严格的标准）会降低统计功效。换句话说，更严格的判断标准使我们更难拒绝正确的零假设，除非数据提供了更强的证据。
- **样本大小与显著性水平**：在设计研究时，研究者通常需要在保持适当统计功效的同时选择合适的样本大小和显著性水平。这通常涉及权衡，因为更大的样本需要更多的资源。


---

### Type I/II error

.center[
&lt;video controls width="800" height="500"&gt;
  &lt;source src="./video/error.mp4", type="video/mp4"&gt;
  &lt;track label="中文" kind="subtitles" srclang="zh" src="./video/error.srt" default&gt;
&lt;/video&gt;
]


---
class: title-slide-section,inverse, middle
# 经验研究中的客观事实是什么?&lt;br&gt; → 总体意义上的模型

---

### 理论、总体分布与样本

&lt;br&gt;

&lt;img src="./figs/BigPicture2.png"&gt;

---
- 模型代表什么?

--

  - 总体意义上的抽象关系

### 条件分布 (Conditional Distribution)
- 刻画变量间关系
  - 观察**条件期望**是最直接、简单办法
- 最感兴趣的 `\(Y\)` 与 `\(X\)` 是随机变量
    - `\(Y\)` 是结果变量（结果变量|结果变量|被解释变量）; `\(X\)` 是干预变量（干预变量|干预变量|解释变量）. 
    - 是随机变量就会有概率分布，而最常见的是**正态分布**

---
### 例子：想知道工资与性别的关系

- 工资对数的条件均值可以写成如下形式：

$$ E[ log(wage) \mid gender = man ] = 3.05 $$

$$ E[ log(wage) \mid gender = woman ] = 2.81 $$
若是我们还好奇在种族与工资的关系，还可以增加新的条件、
$$ E[\log (wage ) \mid gender =\operatorname{man}, race = white]=3.07 $$
$$ E [\log ( wage ) \mid gender = woman, race = black ]=2.73 $$

---
### 通过条件密度函数获得条件期望值
- 离散形式： `$$P(y|x)=\frac{P(y,x)}{P(x)}$$` 其中 `\(P(x)=\sum_{i=1}^{N}P(y_{i},x)\)` ，条件密度相当于联合密度 `\(f(y, x)\)` 在保持x不变情况下的随机化“切片”
- **概率迭代法则**
`$$P(y)=\sum_{i=1}^{N}P(y|x_{i})P(x_{i})$$`   
- **方差加法法则**
`$$Var(Y)=E[V(Y|X)]+V[E(Y|X)]$$`

---
### 通过条件密度函数获得条件期望值

 **为什么**用联合概率分布函数和联合密度函数也可以捕捉两个变量的关系? 
 
--

.middle[
.center[
&lt;img src="figs/logWage_Exp.png" height="450"&gt;
]
]


---
class: title-slide-section,inverse,middle
# 特性良好且能被认知的客观事实&lt;br&gt; → 经验研究是有边界的

---
### 条件期望函数及其误差项的优良性质

.pull-left[
- Conditional Expectation Function Error （CEFE）
$$ e = Y - E(Y|X) = Y - m(x) $$
    - `\(X\)` 是随机变量， `\(E(Y|X)\)` 也是随机变量
    - `\(e\)` 是误差项，也是随机变量，具有概率分布
]

.pull-right[
- CEFE优良性质

    1. `\(E(e|X)=0\)`
    1. `\(E(e)=0\)`
    1. 对于随机变量 `\(X\)` 任意函数形式 `\(h(x)\)` , `\(E(h(X)·e)=0\)` → 通常利用该性质进行线性变换

]

---
### CEF与总体模型间的关系


step1: 定义条件期望函数 `\(m(x) = E(Y|X)\)`

step2: 定义条件期望函数的误差项 `\(e = Y - m(x)\)`

推导出：$$Y = m(x) + e$$

因此模型类别由 `\(m(x)\)` 形式决定：如截距模型，线性模型，Logit模型等

---
### CEF是从样本到总体的桥梁 

- 期望本身是总体概念（价值观）
- 实际中，我们是基于样本信息推断总体信息，例如用样本均值推断总体期望
- 将CEF写作基于样本的CEF:
`\(E[Y_i \mid {X}_{i}]\)` 

从图形上看CEF...

---
class: clear, center, middle

条件分布 `\({Y}_{i}\)`,  对于8, ..., 22不同教育年限的 `\({X}_{i}=x\)`.



&lt;img src="Lec09_files/figure-html/fig_cef_dist-1.svg" style="display: block; margin: auto;" /&gt;
---
class: clear, middle, center
条件期望函数 `\(\mathop{E}\left[ {Y}_{i}\mid {X}_{i} \right]\)` 其实是这些条件分布的均值

&lt;img src="Lec09_files/figure-html/fig_cef-1.svg" style="display: block; margin: auto;" /&gt;

---
class: clear, middle, center

若只关注条件期望函数 `\(\mathop{E}\left[ {Y}_{i}\mid {X}_{i} \right]\)`...

&lt;img src="Lec09_files/figure-html/fig_cef_only-1.svg" style="display: block; margin: auto;" /&gt;
---
## 实际数据（MHE）

.middle[
.center[
&lt;img src="figs/MHE-CEF.png" height="500"&gt;
]
]


---
###  CEF的性质1

.hi.pink[分解结构清楚:] CEF将观测的结果变量分解成两部分

$$
`\begin{align}
  {Y}_{i} = \color{#e64173}{\mathop{E}\left[ {Y}_{i}\mid {X}_{i} \right]} + \color{#6A5ACD}{e_i}
\end{align}`
$$

1. 被 `\(\color{#e64173}{{X}_{i}}\)` 解释的部分(_i.e._, CEF `\(\color{#e64173}{\mathop{E}\left[ {Y}_{i} \mid {X}_{i} \right]}\)`)
&lt;br&gt;
1. 具有特殊性质的干扰项&lt;sup&gt;.pink[†]&lt;/sup&gt;
&lt;br&gt;&lt;br&gt; i.  `\(\color{#6A5ACD}{e_i}\)` 均值独立于  `\({X}_{i}\)`, _i.e._, `\(\mathop{E}\left[ \color{#6A5ACD}{e_i} \mid {X}_{i} \right] = 0\)`
&lt;br&gt; ii.  `\(\color{#6A5ACD}{e_i}\)` 与 `\({X}_{i}\)`的任何函数不相干


.footnote[.pink[†] 回忆之前的例子]

---
###  CEF的性质2
.hi.pink[ANOVA 定理:]

无条件方差与条件方差的关系：可将结果变量 `\(Y_i\)` 方差分解为两部分

$$
`\begin{align}
  \mathop{{Var}} \left( {Y}_{i} \right) =  \mathop{E}\left[ \mathop{{Var}} \left( {Y}_{i} \mid {X}_{i} \right) \right]+ \mathop{{Var}} \left( \color{#e64173}{\mathop{E}\left[ {Y}_{i} \mid {X}_{i} \right]} \right) 
\end{align}`
$$
 
1. 组内方差(的均值)(within group variance)。每个"等级"内Y的分布的方差的期望值(均值)。

2. 组间方差(across group variance)。条件期望值在"等级"间的分布的方差

解释为：结果变量的变动 = CEF的方差(CEF可以解释) .mono[+] 干扰项的方差(CEF无法解释)

---
###  CEF的性质3

.hi.pink[良好预测:]  `\(\mathop{m}\left( {X}_{i} \right)\)` 为 `\({X}_{i}\)` 任意形式函数, CEF是最小均方误差（**性质5**）
$$
`\begin{align}
  \color{#e64173}{\mathop{E}\left[ {Y}_{i} \mid {X}_{i} \right]} = \underset{\mathop{m}\left( {X}_{i} \right)}{{arg min}}\enspace \mathop{E}\left[ \left( {Y}_{i} - \mathop{m}\left( {X}_{i} \right) \right)^2 \right]
\end{align}`
$$
CEF是给定 `\({X}_{i}\)` 能够预测 `\({Y}_{i}\)` 最好预测方式.



 `\(m\)` 可以是任意形式函数（包含非线性），但更偏好**线性投影函数（LPF）**(也叫总体回归模型)

---
### 练习：手算条件期望 → 从数据出发

[CEF基于数据出发，对于理解变量间至关重要](https://pkuzzq-image.oss-cn-beijing.aliyuncs.com/uPic/yh7RUZ.png)

研究问题 `\({E}\left[ {工资}_i \mid {运动技能}_i \right]\)` :

- step 1：选取 `\(Y\)` 与 `\(X\)` (从研究问题出发)

- step 2：在总体中重复抽样，获得样本

- step 3：对 `\(X\)` "切片" ，获得 `\(Y \mid X=x\)` 的 条件密度和条件分布 

- step 4：制作联合密度表格  `\(P(Y=y , X=x)\)`

- step 5：计算边缘密度 `\(P(X=x)\)`

- step 6：制作条件密度表格 `\(P(Y \mid X=x) = \frac{P(Y=y , X=x)} {P(X=x)}\)`

- step 7：计算条件期望 `\(E(Y \mid X=x)\)` 

---
### 条件期望函数及其误差项的优良性质

- **性质1** (期望迭代法则,law of iterated expectation)
$$
E[E[Y \mid X]]=E[Y]
$$

 `\(E[Y|X]\)` 的期望值是 `\([Y]\)` 的无条件期望值。
 &lt;br/&gt;&lt;br/&gt;
例如：
![Fx16GT](https://pkuzzq-image.oss-cn-beijing.aliyuncs.com/uPic/Fx16GT.png)
---
- **性质1**推论
`$$E\left[E[Y|X_{1},X_{2}]|X_{1}\right]=E[Y|X_{1}]$$`
    - 内部期望值以X1和X2同时为条件,外部期望值只以X1为条件。迭代后的期望值可以得到简单的答案E[Y|X1],即只以X1为条件的期望值。《E》表述为"较小的信息集获胜" → 以小谋大
&lt;br/&gt;&lt;br/&gt;
例：
![Q65T2b](https://pkuzzq-image.oss-cn-beijing.aliyuncs.com/uPic/Q65T2b.png)

---
- **性质2** (线性) `$$E[a(X)Y+b(X)|X]=a(X)E[Y|X]+b(X)$$` 对于函数 `\(a(\cdot)\)` and `\(b(\cdot)\)`. 
 &lt;br/&gt;&lt;br/&gt;
 &lt;br/&gt;&lt;br/&gt;

- **性质3**（独立意味着均值独立）
 &lt;br/&gt;&lt;br/&gt;
若 `\(X\)` 与 `\(Y\)` 独立, 则 `\(E[Y|X]=E[Y]\)`

---
- **性质3**的证明 (以离散变量为例): 
$$
`\begin{eqnarray}
E[Y|X]&amp;=&amp;\sum_{i=1}^{N}y_{i}P(Y=y_{i}|X) \\
	  &amp;=&amp;\sum_{i=1}^{N}y_{i}\frac{P(Y=y_{i},X)}{P(X)} \\
	  &amp;=&amp;\sum_{i=1}^{N}y_{i}\frac{P(Y=y_{i})\times P(X)}{P(X)} 
	  &amp;=&amp;E[Y].
\end{eqnarray}`
$$
用到了 `\(P(Y=y,X=x)=P(X=x)P(Y=y)\)` .

---
    
- **性质4** （均值独立意味着不相干）
&lt;br/&gt;
若 `\(E[Y|X]=E[Y]\)`, 则 `\(Cov(X,Y)=0\)`.
    -  `\(E[Y|X]=E[Y]\)` is 均值独立(**mean independence**)
    - 记住: 均值独立意味着不相干，反过来不一定成立.

- **性质5** （条件期望值是最小均值平方误差）
&lt;br/&gt;
假设对于任意函数 `\(g\)` 有 `\(E[Y^{2}]&lt;\infty\)` 并 `\(E[g(X)]&lt;\infty\)` , 那么 `$$E[(Y-\mu(X))^{2}]\leq E[(Y-g(X))^{2}]$$` 
其中 `\(\mu(X)=E[Y|X]\)`
&lt;br/&gt;
解读:
    - 假设使用某种函数形式 `\(g\)` 和数据 `\(X\)` 来解释 `\(Y\)`
    -  那么 `\(g\)` 的最小均方误（ **the mean squared error** ）就是条件期望。


---

- **性质5**的证明:
$$
`\begin{eqnarray}
E[(Y-g(X))^{2}]	&amp;=&amp;E[\left\{ \left(Y-\mu(X)\right)+\left(\mu(X)-g(X)\right)\right\} ^{2}]\\
	&amp;=&amp;E\left[\left(Y-\mu(X)\right)^{2}\right]+E\left[\left(\mu(X)-g(X)\right)^{2}\right]\\
	&amp;+&amp; 2E\left[\left(Y-\mu(X)\right)\left(\mu(X)-g(X)\right)\right].
\end{eqnarray}`
$$
使用期望迭代法则
$$
`\begin{eqnarray}
E\left[\left(Y-\mu(X)\right)\left(\mu(X)-g(X)\right)\right]	&amp;=&amp;E\left\{E\left[\left(Y-\mu(X)\right)\left(\mu(X)-g(X)\right)|X\right]\right\} \\
	&amp;=&amp;E\left\{ \left(\mu(X)-g(X)\right)\left(E[Y|X]-\mu(X)\right)\right\} \\
	&amp;=&amp;0
\end{eqnarray}`
$$
所以，
$$
E[(Y-g(X))^{2}]=E\left[\left(Y-\mu(X)\right)^{2}\right]+E\left[\left(\mu(X)-g(X)\right)^{2}\right]
$$ 
上式取最小值，当且仅当 `\(g(X)=\mu(X)\)`.


---
### 经验研究为什么从LPF而不是CEF开始？

- .bb[Meaningful] !!  → 实证模型的建立基于的理论模型

- 线性CEF不是也有经济意义么? 未必。
&lt;br&gt; → 一个原因是：总体模型 `\(m(x1,x2)\)` 等价线性CEF形式为 `\(m\left(x_{1}, x_{2}\right)=x_{1} \beta_{1}+x_{2} \beta_{2}+x_{1}^{2} \beta_{3}+x_{2}^{2} \beta_{4}+x_{1} x_{2} \beta_{5}+\beta_{6}\)`  

- 转向LPF(linear projection function) 
&lt;br&gt; `\(m^{LPF}\left(x_{1}, x_{2}\right)=x_{1} \beta_{1}+x_{2}\beta_{2}+\beta_{3}\)` 

---
### 经验研究为什么从LPF而不是CEF开始？

- LPF是MSE最小的线性函数:

$$
`\begin{align}
  \beta = \underset{b}{{arg min}}\thinspace \mathop{E}\left[ \left( {Y}_{i} - {X}_{i}'b \right)^2 \right]
\end{align}`
$$

- 依据一阶条件: `\(\mathop{E}\left[ {X}_{i} \left( {Y}_{i} - {X}_{i}'b \right) \right] = 0\)`得到 `\(b\)` 的最优解 `\(\beta = \mathop{E}\left[ {X}_{i} {X}_{i}' \right]^{-1} \mathop{E}\left[ {X}_{i} {Y}_{i} \right]\)`
- `\(X_{i}^{\prime} \beta\)` 是 `\(Y_i\)` 在 `\(X_i\)` 上的最优线性投影（best linear projection, BLP）, 向量 `\(\beta\)` 是线性投影系数（linear projection coefficient） 
- 根据一阶条件重新构建 `\(E\left[X_{i}\left(Y_{i}-X_{i}^{\prime} \beta\right)\right]=0\)` , 也就是说 `\(Y\)` 的线性投影函数误差(linear projection function error,LPFE )
`\(e_i = Y_i - X_{i}^{\prime} \beta\)` 与 `\(X_i\)` 不相关, 也就是说LPF具有
`\(E(X_i e_i) = 0\)` (矩阵形式为 `\(E[Xe]=0\)` )
的性质.

- .hi.pink[思考：]与CEFE的性质比较

---
### 经验研究为什么从LPF而不是CEF开始？

- .bb[补充一个知识点]:CEF 还有一个非常好的性质 → 预测

- 好”的**准则**。定义**损失函数(loss function)**,  表达为常用的二次型形式：

$$ L(Y, g(x))=(Y-g(x))^{2} $$
- 其中 `\(L(·)\)` 是r.v.，取期望得**均值平方误差（mean squared error，MSE）**，简称**均方误**
$$ R(Y, g(x)) = E[L(Y, g(x))] = E[(Y-g(x))^{2}] $$

---
### 经验研究为什么从LPF而不是CEF开始？

- CEF是MMSE → LPF 也是MMSE。继续使用最小化MSE**准则**：
$$
`\begin{align}
  \beta = \underset{b}{{arg min}}\thinspace \mathop{E}\left[ \left( m({X_i})-{X_i}^{\prime} b \right)^2 \right]
\end{align}`
$$

- 回归与条件期望函数定理（ Regression-CEF Theorem）
- 结论：
  - **LPF是CEF的MMSE(最小均方误)和BLP(最优线性预测)**
  - 通常而言，CEF不一定是线性的(才需要多项式表达) &lt;br&gt; 但CEF若是线性的, 那么LPF就是CEF

---
class: clear, middle, center
**CEF**

&lt;img src="Lec09_files/figure-html/fig_reg_cef-1.svg" style="display: block; margin: auto;" /&gt;
---
class: clear, center, middle

**LPF**去估计**CEF**

&lt;img src="Lec09_files/figure-html/fig_reg_cef2-1.svg" style="display: block; margin: auto;" /&gt;
---

### 实际数据

.middle[
.center[
&lt;img src=https://pkuzzq-image.oss-cn-beijing.aliyuncs.com/uPic/RgBq9Q.png height="500"&gt;
]
]

---
### 推断因果是基于CEF而不是LPF


- 若CEF是相关关系的 .mono[--&gt;] LPF是相关的

- 若CEF是因果关系 .mono[--&gt;] LPF是因果的

- 问题是：怎样获得一个因果的 CEF ？(客观)

  .mono[--&gt;]  必须依赖于理论认知(主观) 


---
### 推断因果是基于CEF而不是LPF，但经验研究更多从LPF出发

- .hi-pink.bb[实际上]的做法是使用 LPF 进行建模(to see is to believe)

- 由于只有 **线性CEF .mono[=] LPF**，即使使用了**模型设定**正确的LPF，      
一部分信息(高阶项)也会**先天地**进入到了干扰项 `\(e\)` ，所以**必须**假定 **干扰项条件均值独立于干预变量** ，即  `\(E(e \mid X) = E(e)=c\)` ，才保证LPF的估计系数距离线性CEF的真实值不远

- 即便统计推断可靠，总体是线性CEF的形式仍然是概率事件，这就凸显了**识别过程的重要性**

---
class: title-slide-section,inverse,middle
# 因果模型 &lt;br&gt; → 建立在潜在结果框架之下   

---
### 理论、总体分布与样本

&lt;br&gt;
&lt;img src="./figs/BigPictureC.png"&gt;

---

### 个体处置效应

-   `\(Y_{i}\)`: 对个体的 `\(i\)` **观察结果**, 每个个体都有2个**潜在结果**
-   `\(D_{i}\)`: 二元 **干预状态** 

1. `\(\color{#e64173}{{Y}_{i}(1)}\)` .pink[若] `\(\color{#e64173}{{D}_i = 1}\)`
&lt;br&gt; 表示： `\(\color{#e64173}{i}\)`  .pink[ 干预后的结果]


2. `\(\color{#6A5ACD}{{Y}_{i}(0)}\)` .purple[若] `\(\color{#6A5ACD}{{D}_i = 0}\)`
&lt;br&gt; 表示： `\(\color{#6A5ACD}{i}\)`  .purple[没有被干预的结果]


两者之差就是 .hi-orange[个体处置效应], 
$$
`\begin{align}
  \color{#FFA500}{\tau_i} = \color{#e64173}{{Y}_{i}(1)} - \color{#6A5ACD}{{Y}_{i}(0)}
\end{align}`
$$

- 个体处置效应存在异质性

---

### 因果推断的根本难点在于反事实无法观测

.hi-slate[问题是] 无法直接计算: `\(\color{#FFA500}{\tau_i} = \color{#e64173}{{Y}_{i}(1)} - \color{#6A5ACD}{{Y}_{i}(0)}\)`

- 数据上只能同时观察每个个体的 `\((Y_{i},D_{i})\)` 

- 永远无法**同时**观 `\({Y}_{i}(0)\)` 和 `\({Y}_{i}(1)\)`, 必须借助**反事实（conterfactual）**概念


.mono[--&gt;] **两个潜在结果只能观测其一**，这就是Holland(1986)提出的**因果推断的根本难点**

---
### 系数的重新命名

-   **个体处置效应：** `\(\color{#FFA500}{\tau_i} = \color{#e64173}{{Y}_{i}(1)} - \color{#6A5ACD}{{Y}_{i}(0)}\)` 
    -   关键点: **因人而异**
    -   由于潜在结果根本矛盾而永远无法获得
    
    
-   作为替代转向**总体平均处置效应 (Average Treatment Effect)**： 用于描述处置效应的平均效果
    - `\(ATE=E[{Y}_{i}(1)-{Y}_{i}(0)]\)` ，ATE只是这些异质性干预的平均值。
-   干预组平均处置效应(最关注的效应，是干预行为的直接后果): 
    - `\(ATT=E[{Y}_{i}(1)-{Y}_{i}(0)|D_{i}=1]\)`
-   控制组平均处置效应:  
    - `\(ATU=E[{Y}_{i}(1)-{Y}_{i}(0)|D_{i}=0]\)`
-   协变量条件平均处置效应:  
    - `\(ATE(x)=E[{Y}_{i}(1)-{Y}_{i}(0)|D_{i}=1,X_{i}=x]\)`
    
---
### ATE与ATT、ATU的关系

-   总体平均处置效应 (ATE)
$$
`\begin{aligned}
A T E &amp;=E\left[Y_{i}(1)-Y_{i}(0)\right] \\
&amp;=E\left[Y_{i}(1)\right]-E\left[Y_{i}(0)\right] \\
&amp;=\omega \times A T T+(1-\omega) \times A T U
\end{aligned}`
$$
- ATE是ATT和ATU的加权平均

---
### 观察结果

- 个体根据是否接受了干预而表现出来的潜在结果
- 可表示为潜在结果和干预状态的函数
 `\(Y_{i}=Y_{i}(0)+\left[Y_{i}(1)-Y_{i}(0)\right] \times D_{i}\)`
- `\(D_{i}=0\)` 表示个体 `\(i\)` 没有接受干预, `\(Y_{i}=Y_{i}(0)\)` 
- `\(D_{i}=1\)` 表示接受了干预, `\(Y_{i}=Y_{i}(1)\)` 

---

### 所谓的“朴素”估计量

.hi-slate[问题] 既然 ATE、ATT和ATU均无法获得

&lt;br&gt;.hi-slate[简单方案]:

直接比较 .pink[干预组] `\(\left( \color{#e64173}{{Y}_{i}(1)\mid \color{#e64173}{{D}_{i}=1}} \right)\)` 和 .purple[控制组] 均值, 即: `\(\left( \color{#6A5ACD}{{Y}_{i}(0)\mid \color{#6A5ACD}{{D}_{i}=0}} \right)\)`.

$$
`\begin{align}
  \mathop{E}\left[ {Y}_{i} \mid \color{#e64173}{{D}_{i}=1} \right] - \mathop{E}\left[ {Y}_{i}\mid \color{#6A5ACD}{{D}_{i}=0} \right]
\end{align}`
$$

---
### 3种“朴素”估计偏误形式

`\(\mathop{E}\left[ {Y}_{i} \mid \color{#e64173}{{D}_{i}=1} \right] - \mathop{E}\left[ {Y}_{i}\mid \color{#6A5ACD}{{D}_{i}=0} \right]\)`
&lt;br&gt;  `\(= \underbrace{\mathop{E}\left[ \color{#e64173}{{Y}_{i}(1)}\mid \color{#e64173}{{D}_{i}=1} \right] - \mathop{E}\left[ \color{#6A5ACD}{{Y}_{i}(0)}\mid \color{#e64173}{{D}_{i}=1} \right]}_{ATT\ 😀} + \underbrace{\mathop{E}\left[ \color{#6A5ACD}{{Y}_{i}(0)}\mid \color{#e64173}{{D}_{i}=1} \right] - \mathop{E}\left[ \color{#6A5ACD}{{Y}_{i}(0)}\mid \color{#6A5ACD}{{D}_{i}=0} \right]}_{ATT估计偏差\ 😞}\)`
&lt;br&gt;  `\(= \underbrace{\mathop{E}\left[ \color{#e64173}{{Y}_{i}(1)}\mid \color{#6A5ACD}{{D}_{i}=0} \right] - \mathop{E}\left[ \color{#6A5ACD}{{Y}_{i}(0)}\mid \color{#6A5ACD}{{D}_{i}=0} \right]}_{ATU\ 😀} + \underbrace{\mathop{E}\left[ \color{#e64173}{{Y}_{i}(1)}\mid \color{#e64173}{{D}_{i}=1} \right] - \mathop{E}\left[ \color{#e64173}{{Y}_{i}(1)}\mid \color{#6A5ACD}{{D}_{i}=0} \right]}_{ATU估计偏差\ 😞}\)`
&lt;br&gt;  `\(=  {\underbrace{\omega \times(\mathop{E}\left[ \color{#e64173}{{Y}_{i}(1)}\mid \color{#e64173}{{D}_{i}=1} \right]-\mathop{E}\left[ \color{#6A5ACD}{{Y}_{i}(0)}\mid \color{#e64173}{{D}_{i}=1} \right]) + (1-\omega) \times(\mathop{E}\left[ \color{#e64173}{{Y}_{i}(1)}\mid \color{#6A5ACD}{{D}_{i}=0} \right]-\mathop{E}\left[ \color{#6A5ACD}{{Y}_{i}(0)}\mid \color{#6A5ACD}{{D}_{i}=0} \right])}_{ATE\ 😀}}\)` 
&lt;br&gt;  `\(+  {\underbrace{\omega \times(\mathop{E}\left[ \color{#6A5ACD}{{Y}_{i}(0)}\mid \color{#e64173}{{D}_{i}=1} \right]-\mathop{E}\left[ \color{#6A5ACD}{{Y}_{i}(0)}\mid \color{#6A5ACD}{{D}_{i}=0} \right])+(1-\omega) \times(\mathop{E}\left[ \color{#e64173}{{Y}_{i}(1)}\mid \color{#e64173}{{D}_{i}=1} \right]-\mathop{E}\left[ \color{#e64173}{{Y}_{i}(1)}\mid \color{#6A5ACD}{{D}_{i}=0} \right])}_{ATE估计偏差\ 😀}}\)`

---
### 选择偏误 selection bias

- ATE估计偏差 `\(= \omega \times\)` ATT估计偏差 `\(+ (1-\omega)\)` ATU估计偏差 

    - 造成ATE 估计偏差的原因包含造成 ATT 和 ATU  估计偏差的原因
    
- 造成“朴素”估计量估计处置效应产生偏差的原因：

  1. **非随机因素**导致接受干预
  2. 若这个非随机因素是**个体的自我选择**，其造成的估计偏误就是**选择偏误**（selection bias）
  3. 目标，使得选择偏误 → 0
  
---
### 例子： 吃药对健康的影响

![y8Xmf9](https://pkuzzq-image.oss-cn-beijing.aliyuncs.com/uPic/y8Xmf9.png)
- “上帝”视角
- 阴影部分为可观测到的结果，而下划线部分为无法观测到的**反事实结果**

---
### 例子： 吃药对健康的影响

- 干预组：  `\(T1=\mathop{E}\left[ \color{#e64173}{{Y}_{i}(1)}\mid \color{#e64173}{{D}_{i}=1} \right]; \quad T0=\mathop{E}\left[ \color{#6A5ACD}{{Y}_{i}(0)}\mid \color{#e64173}{{D}_{i}=1} \right]（反事实）\)` 
  
- 控制组：  `\(C0=\mathop{E}\left[ \color{#6A5ACD}{{Y}_{i}(0)}\mid \color{#6A5ACD}{{D}_{i}=0} \right]; \quad C1=\mathop{E}\left[ \color{#e64173}{{Y}_{i}(1)}\mid \color{#6A5ACD}{{D}_{i}=0} \right]（反事实）\)` 

![ueiga0](https://pkuzzq-image.oss-cn-beijing.aliyuncs.com/uPic/ueiga0.png)

---
### 例子： 吃药对健康的影响

若知道所有个体的潜在结果, 就可以得到准确的平均处置效应
- ATT `\((\)`接受干预的个体的平均处置效应 `\()=T 1-T 0=3.3\)`
- ATU `\((\)`未接受干预的个体的平均处置效应 `\()=C 1-C 0=3\)`
- ATE `\((\)` 总体平均处置效应 `\()=\omega \times A T T+(1-\omega) \times A T U\)` `\(=3.18\)`


但在实际情况中, 无法观测到反事实结果
- 存在偏误的“朴素” 估计量 `\(=T 1-C 0=2.8\)`
- 存在偏误的ATT `\(=T 0-C 0=-0.5\)`
- 存在偏误的ATU `\(=T 1-C 1=-0.2\)`
- 存在偏误的ATE `\(=\omega \times(T 0-C 0)+(1-\omega) \times(T 1-C 1)=-0.38\)` 

- 三组有不同程度的偏差
---

&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;
.hi-pink[问题：]既然由于反事实的根本问题存在，通常使用"朴素"估计量又会存在选择偏误，那么如何通过观测数据识别处置效应?

.hi-pink[回答：] 通过研究设计

---
### 理论、总体分布与样本

&lt;br&gt;
&lt;img src="./figs/BigPictureC2D.png"&gt;

---

### 研究设计：随机实验

- 理解一：潜在结果独立性假设（independence assumption）

 `$$\left\{{Y}_{{i}}(1), Y_{i}(0)\right\} \perp D_{i}$$`

- 理解二：**可观测特征、不可观测特征和处置效应**完全独立于是否接受干预，也就是说那些干扰因素在随机分配后都要被控制
  
  - 若潜在结果可以表示为可观测特征 `\(X_{i}\)` 、不可观测特征 `\(e_{i}\)` 和处置效应 `\(\tau_{i}\)` 的函数
$$
`\begin{aligned}
&amp;Y_{i}(0)=a+b X_{i}+{e}_{{i}}, D_{i}=0 \\
&amp;Y_{i}(1)=a+\tau_{i}+b X_{i}+{e}_{{i}}, D_{i}=1 \\
&amp;\left(X_{i}, e_{i}, \tau_{i}\right) \perp D_{i}
\end{aligned}`
$$
  - 通俗理解: 将总体随机分为干预组和控制组, 个体的特征在总体、干预组、控制组均一致

---
### 研究设计：随机实验

- 问题是：班级人数对学生成绩的影响？
.pull-left[
&lt;img src="figs/随机分配.svg" &gt;
]

.pull-right[

- 总体随机抽取各1000人
- 可观测特征：性别、年龄、教育程度
- 不可观测特征：个性、学习动力
- 处置效应：在两组分布没有差异
]
---
### 潜在结果独立假设包含的两个“独立”(1)

- 独立性的第1个维度: 未受干预个体的潜在结果独立于干预变量
 `$$\left\{Y_{i}(0)\right\} \perp D_{i}$$`

    - 意味着, 它的均值也和 `\(D_{i}\)` 不相关

 `$$\mathop{E}\left[ \color{#6A5ACD}{{Y}_{i}(0)}\mid \color{#6A5ACD}{{D}_{i}=0} \right]=\mathop{E}\left[ \color{#6A5ACD}{{Y}_{i}(0)}\mid \color{#e64173}{{D}_{i}=1} \right]$$`

    - 化简为: `\({E}\left[Y_{i}(0) \mid {D}_{i}\right]={E}\left[Y_{i}(0)\right]\)`
    
    - 该条件就意味着， `\({T} 0={C} 0\)` 

- 通俗理解: 可以用控制组的观测结果 `\(C0\)` 来衡量不可观测的反事实结果 `\({T}0\)`, 此时干预组的平均处置效应ATT无偏
`$$T 1-C 0=\underbrace{({T} 1-{T} 0)}_{\text {ATT }}+\underbrace{({T} 0-{C} 0)}_{\text {ATT的偏差 }=0}=A T T$$`

---
### 潜在结果独立假设包含的两个“独立”(2)
- 独立性的第2个维度: 接受干预个体的潜在结果独立于干预变量
 `$$\left\{Y_{i}(1)\right\} \perp D_{i}$$`

    - 意味着, 它的均值也和 `\(D_{i}\)` 不相关

 `$$\mathop{E}\left[ \color{#e64173}{{Y}_{i}(1)}\mid \color{#e64173}{{D}_{i}=1} \right]=\mathop{E}\left[ \color{#e64173}{{Y}_{i}(1)}\mid \color{#6A5ACD}{{D}_{i}=0} \right]$$`

    - 同理: `\({E}\left[Y_{i}(1) \mid {D}_{i}\right]={E}\left[Y_{i}(1)\right]\)`
    
    - 该条件就意味着， `\({C} 1={T} 1\)` 

- 通俗理解: 可以用干预组的观测结果 `\(T1\)` 来衡量不可观测的反事实结果 `\({C}1\)`, 此时控制组的平均处置效应ATU无偏
`$$T 1-C 0=\underbrace{({C} 1-{C} 0)}_{\text {ATU }}+\underbrace{({T} 1-{C} 1)}_{\text {ATU的偏差 }=0}=A T T$$`

---
### 研究设计：类似RCT的回归

&lt;br&gt;&lt;br&gt;&lt;br&gt;&lt;br&gt;
- RCT实验昂贵
- 以人为实验对象会受伦理审查委员会严格审查
- 那么当不是RCT时，是否也可以使用"朴素"估计量呢？

--

- .hi-pink[回答：] 可以，但需要施加**额外假设**。只要潜在结果的差异是由是否接受干预和**可观测的**个体特征造成时，就可以通过**控制可观测的个体特征**来消除选择偏差

---
### 研究设计：CMI假设下，控制可观测特征 + 回归 → 消除选择偏误

- 药物与健康的例子
    - 服药个体普遍年龄偏大，且年龄大的个体普遍的潜在健康状况差 → 年龄因素与健康Y负相关
    - 对干预组和控制组的年龄进行分类，相同年龄段来比较用药前后的健康状况的差异（同年龄段内，干预组和控制组可以看成随机分配，满足潜在结果独立性假设）
.center[
![KQ0CRA](https://pkuzzq-image.oss-cn-beijing.aliyuncs.com/uPic/KQ0CRA.png)
]
- `\(ATT(30)=ATU(30)=ATE(30)=T1(30) - C0(30)\)` 
- `\(ATT(40)=ATU(40)=ATE(40)=T1(40) - C0(40)\)` 
- `\(ATT=P(30 | D = 1 ) × ATT(30) + P (40 | D = 1) × ATT(40)\)` 

---
### 研究设计：CMI假设下，控制可观测特征 + 回归 → 消除选择偏误

- 给定可观测特征条件 `\(X_{i}=x\)` 的干预组和控制组
$$
`\begin{aligned}
&amp;A T T(x)=T 1(x)-C 0(x) \\
&amp;A T T=\sum_{x} P(x \mid D=1) \times {ATT}(x)
\end{aligned}`
$$

- 有 `\(A T E={E}_{x}[{ATE}(X)]=\sum_{x} P(x) \times ATE(x)\)`

该假设称为: **条件均值独立假设(CMI)**
`\({E}\left[Y_{i}(0) \mid D_{i}=1, X_{i}=x\right]={E}\left[Y_{i}(0) \mid D_{i}=0, X_{i}=x\right]={E}\left[Y_{i}(0)=x\right]\)`
`\({E}\left[Y_{i}(1) \mid D_{i}=1, X_{i}=x\right]={E}\left[Y_{i}(1) \mid D_{i}=0, X_{i}=x\right]={E}\left[Y_{i}(0)=x\right]\)`

- 满足CMI最直接的方式是条件随机分配, 如给定30岁群体, 从中随机抽取 一些人服药、一些人不服药
- CMI只能估计该条件下ATE, 更强的假设是**条件独立假设（CIA）**

---
### 若我们关心总体：从CMI到条件独立假设 CIA

.note[定义]:

-  在 `\({X}_{i}\)` 的条件下,潜在结果 `\(\left(\color{#6A5ACD}{{Y}_{i}(0)},\, \color{#6A5ACD}{{Y}_{i}(1)} \right)\)` 与干预变量 `\(\color{#e64173}{{D}_{i}}\)` 独立(选择偏误消失), 数学形式为:

$$
`\begin{align}
  \def\ci{\perp\mkern-10mu\perp}
  \left\{ \color{#6A5ACD}{{Y}_{i}(0)},\,\color{#6A5ACD}{{Y}_{i}(1)} \right\} \ci  \color{#e64173}{{D}_{i}} | {X}_{i}
\end{align}`
$$
 &lt;br&gt;
- 选择偏误 `\(= \mathop{E}\left[ \color{#6A5ACD}{{Y}_{i}(0)} \mid {X}_{i},\, \color{#e64173}{{D}_{i}= 1} \right] - \mathop{E}\left[ \color{#6A5ACD}{{Y}_{i}(0)} \mid {X}_{i},\, \color{#e64173}{{D}_{i}= 0} \right]\)`
&lt;br&gt;.white[选择偏误] `\(= \mathop{E}\left[ \color{#6A5ACD}{{Y}_{i}(0)} \mid {X}_{i} \right] - \mathop{E}\left[ \color{#6A5ACD}{{Y}_{i}(0)} \mid {X}_{i} \right]\)`
&lt;br&gt;.white[选择偏误] `\(= 0\)`

???
前面假设我们只能获得ATT，但是想要ATE或者ATU呢？

---
### 若我们关心总体：从CMI到条件独立假设 CIA

- CIA的意思是：控制协变量 `\({X}_{i}\)` 后, 干预措施就像  .hi-slate[随机分配一样]

- 将之前的"朴素"估计量写为在控制 `\({X}_{i}\)` 的条件下

$$
`\begin{align}
  &amp;\mathop{E}\left[ \color{#6A5ACD}{{Y}_{i}} \mid {X}_{i},\, \color{#e64173}{{D}_{i}=1} \right] - \mathop{E}\left[ \color{#6A5ACD}{{Y}_{i}} \mid {X}_{i},\, \color{#e64173}{{D}_{i}=0} \right] \\[0.5em]
  &amp;= \mathop{E}\left[ \color{#6A5ACD}{{Y}_{i}(1)} \mid {X}_{i} \right] - \mathop{E}\left[ \color{#6A5ACD}{{Y}_{i}(0)} \mid {X}_{i} \right] \\[0.5em]
  &amp;= \mathop{E}\left[ \color{#6A5ACD}{{Y}_{i}(1)} - \color{#6A5ACD}{{Y}_{i}(0)} \mid {X}_{i} \right]
\end{align}`
$$

---
### 若我们关心剂量多少而不是是否干预：扩展的CIA

.pink.hi[继续考虑：教育回报率的例子]

- 现在，将CIA拓展到**多值**干预变量的情况，如.pink[接受教育年限] `\(\left( \color{#e64173}{s_i} \right)\)` 取值为整数 t `\(\in\left\{ 0,\,1,\,\ldots,\, T \right\}\)`。由于受教育水平和收入之间的因果关系可能因人而异，所以我们用个体的收入函数：
$$
`\begin{align}
  \color{#6A5ACD}{{Y}_{si}} \equiv \mathop{f_i}(\color{#e64173}{s})
\end{align}`
$$
- `\(\color{#6A5ACD}{{Y}_{i}(1)}\)` 为个体 `\(i\)` 是否接受教育的潜在收入 → `\(\color{#6A5ACD}{{Y}_{si}}\)` 是个体 `\(i\)` 接受 `\(s\)` 年教育后的潜在收入，函数 `\(\mathop{f_i}(\color{#e64173}{s})\)` 告诉我们：即使个体 `\(i\)` 接受 `\(s\)` 的潜在收入是因人而异的（符合理论）
→  `\(\mathop{f_i}(\color{#e64173}{s})\)` 回答了“如果……，就会……”这样的一个因果性问题

- 模型建构具有一般性，因为两个人即使接受相同的教育年限，但潜在的收入也可能是不同的

---
### 若我们关心剂量多少而不是是否干预：扩展的CIA

- 将 CIA 扩展到多值干预变量 
- CIA表示在给定控制变量集合 `\(X_i\)`的条件下，潜在结果 `\(\color{#6A5ACD}{{Y}_{si}}\)` 和 `\(\color{#e64173}{s_i}\)` 是相互独立的，在更一般的条件下，CIA变为∶
.center[
`\(\color{#6A5ACD}{{Y}_{si}} \ci \color{#e64173}{s_i} \mid {X}_{i}\enspace\)` 对于 `\(\color{#e64173}{s}\)` 的每个取值
]
- 给定 `\(X_i\)`  ，多接受一年教育带来的平均处置效应就是 `\(\mathop{E}\left[ \mathop{f_i}(\color{#e64173}{s}) - \mathop{f_i}(\color{#e64173}{s-1}) \mid {X}_{i} \right]\)` ，多接受四年教育带来的平均处置效应就是 `\(\mathop{E}\left[ \mathop{f_i}(\color{#e64173}{s}) - \mathop{f_i}(\color{#e64173}{s-4}) \mid {X}_{i} \right]\)` 
- 数据只能告诉我们 `\(\color{#6A5ACD}{{Y}_{i}} = f_i(\color{#e64173}{s_i})\)` ，也就是当 `\(\color{#e64173}{s}=\color{#e64173}{s_i}\)` 取定每个人接受的教育年限时的 `\(f_i(\color{#e64173}{s_{i}})\)` 

- 在CIA"护身符"下，给定 `\(X_i\)` ，不同教育水平下平均收入的差异就可解释为教育的处置效应。因此多接受1年教育的处置效应可以写为:
$$
`\begin{align}
  \mathop{E}\left[ \color{#6A5ACD}{{Y}_{i}} \mid {X}_{i},\, \color{#e64173}{s_i = s} \right] - \mathop{E}\left[ \color{#6A5ACD}{{Y}_{i}} \mid {X}_{i},\, \color{#e64173}{s_i = s-1} \right]=
  \mathop{E}\left[ \mathop{f_i}(\color{#e64173}{s}) - \mathop{f_i}(\color{#e64173}{s-1}) \mid {X}_{i} \right]
\end{align}`
$$
  - 对任何的 `\(s\)` 的取值都成立 → 该假设可能**很强**，因为多接受小学1年和大学1年很可能不同
  
---
### 若我们关心剂量多少而不是是否干预：扩展的CIA

在CIA下，给定 `\({X}_{i}\)`, 潜在结果 `\(\color{#6A5ACD}{{Y}_{si}}\)` 和每个人的干预剂量多少 `\(\color{#e64173}{s_i}\)` 是独立的:

$$
`\begin{align}
\def\ci{\perp\mkern-10mu\perp}
  &amp;\mathop{E}\left[ \color{#6A5ACD}{{Y}_{i}} \mid {X}_{i},\, \color{#e64173}{s_i = s} \right] - \mathop{E}\left[ \color{#6A5ACD}{{Y}_{i}} \mid {X}_{i},\, \color{#e64173}{s_i = s-1} \right] \\[0.5em]
  &amp;=\mathop{E}\left[ \color{#6A5ACD}{f_{i}(s_{i})} \mid {X}_{i},\, \color{#e64173}{s_i = s} \right] - \mathop{E}\left[ \color{#6A5ACD}{f_{i}(s_{i})} \mid {X}_{i},\, \color{#e64173}{s_i = s-1} \right] \\[0.5em] 
  &amp;=\mathop{E}\left[ \color{#6A5ACD}{f_{i}(s)} \mid {X}_{i},\, \color{#e64173}{s_i = s} \right] - \mathop{E}\left[ \color{#6A5ACD}{f_{i}(s-1)} \mid {X}_{i},\, \color{#e64173}{s_i = s-1} \right] \\[0.5em]
  &amp;=\mathop{E}\left[ \color{#6A5ACD}{{Y}_{si}} \mid {X}_{i},\, \color{#e64173}{s_i = s} \right] - \mathop{E}\left[ \color{#6A5ACD}{{Y}_{(s-1)i}} \mid {X}_{i},\, \color{#e64173}{s_i = s-1} \right] \\[0.5em]
  {CIA:} f_{i}(s) \ci s_{i} \mid X_{i} \\[0.5em] 
  &amp;=\mathop{E}\left[ \color{#6A5ACD}{{Y}_{si}} \mid {X}_{i} \right] - \mathop{E}\left[ \color{#6A5ACD}{{Y}_{(s-1)i}} \mid {X}_{i} \right] \\[0.5em]
  &amp;=\mathop{E}\left[ \color{#6A5ACD}{{Y}_{si}} - \color{#6A5ACD}{{Y}_{(s-1)i}} \mid {X}_{i} \right] \\[0.5em]
  &amp;=\mathop{E}\left[ \mathop{f_i}(\color{#e64173}{s}) - \mathop{f_i}(\color{#e64173}{s-1}) \mid {X}_{i} \right]
\end{align}`
$$

- CIA下 → 控制条件后，相差1年教育的人的收入均值的差异就可以解释为**多接受1年教育的平均处置效果**

---
### 若我们关心剂量多少而不是是否干预：扩展的CIA

.hi-pink[例子] 可以比较教育水平为11年和12年的个体间平均收入的差别，以此来了解高中毕业带来的平均处置效应
.big-left[
`\(\mathop{E}\left[ \color{#6A5ACD}{{Y}_{i}} \mid {X}_{i},\, \color{#e64173}{s_i = 12} \right] -   \mathop{E}\left[ \color{#6A5ACD}{{Y}_{i}} \mid {X}_{i},\, \color{#e64173}{s_i = 11} \right]\)`
]
.big-left[
`\(=\mathop{E}\left[ f_i(\color{#e64173}{12}) \mid {X}_{i},\, \color{#e64173}{s_i = 12} \right] -   \mathop{E}\left[ f_i(\color{#e64173}{11}) \mid {X}_{i},\, \color{#e64173}{s_i = 11} \right]\)`
]
.big-left[
`\(=\mathop{E}\left[ f_i(\color{#e64173}{12}) \mid {X}_{i},\, \color{#e64173}{s_i = 12} \right] -   \mathop{E}\left[ f_i(\color{#e64173}{11}) \mid {X}_{i},\, \color{#e64173}{s_i = 12} \right]\)`  .grey-light[(CIA)]
]
.big-left[
`\(=\mathop{E}\left[ f_i(\color{#e64173}{12}) - f_i(\color{#e64173}{11}) \mid {X}_{i},\, \color{#e64173}{s_i = 12} \right]\)`
]
.big-left[
`\(=\)` .hi[给定] `\(X_{i}\)` .hi[下] , .hi[已高中毕业学生]因高中毕业带来的平均处置效应 
]
.big-left[
`\(=\mathop{E}\left[ f_i(\color{#e64173}{12}) - f_i(\color{#e64173}{11}) \mid {X}_{i} \right]\)` .grey-light[(再次CIA)]
]
.big-left[
`\(=\)` .hi[给定] `\(X_{i}\)` .hi[下] , 高中是否毕业（为条件）的平均处置效应
]

---
### 若我们关心剂量多少而不是是否干预：扩展的CIA（从多条件到无条件）

- 目前为止，对 `\(X_i\)` 可取的每一个值都构造了一个处置效果 `\(ATE_{X_i=x}\)` 。这样做的结果是协变量 `\(X_i\)` 有多少个条件取值就可能会存在多少处置效果

- 就刚才例子，如果CIA假设满足，我们可以计算任意条件(组合)下的教育年限为12和11的人的平均收入的差来得到该条件下的处置效应。例如 `\(X_i\)` 包含的变量为（Sex，Age）。那么，Sex=1表示女性，Age的取值范围从20-60。在上面的条件下，一个因果关系可以表示为：

- `\(E[f_i(\color{#e64173}{12})-f_i(\color{#e64173}{11}) \mid\)` Sex `\(=1\)`, Age `\(=20至30]\)` 表示20至30岁的女性，高中毕业比高中肄业的平均教育回报水平。
- `\(E[f_i(\color{#e64173}{12})-f_i(\color{#e64173}{11}) \mid\)` Sex `\(=0\)`, Age `\(=65岁以上]\)` 表示65岁以上的男性，高中毕业比高中肄业的平均教育回报水平
- 能否获得高中毕业比高中肄业的平均教育回报水平呢？

---

### 若我们关心剂量多少而不是是否干预：扩展的CIA（从多条件到无条件）

.pink.hi[问题] 那么.hi-pink[无条件]高中毕业相对于高中肄业的平均处置效应是什么?

.pink.hi[回答] 利用迭代期望定理对不同的因果效果进行综合。首先, 回忆下刚证明的...

$$
`\begin{align}
  \mathop{E}\left[ \color{#6A5ACD}{{Y}_{i}} \mid {X}_{i},\, \color{#e64173}{s_i = 12} \right] -  \mathop{E}\left[ \color{#6A5ACD}{{Y}_{i}} \mid {X}_{i},\, \color{#e64173}{s_i = 11} \right] = \mathop{E}\left[ f_i(\color{#e64173}{12}) - f_i(\color{#e64173}{11}) \mid {X}_{i} \right]
\end{align}`
$$

现在取两边的期望值并应用迭代期望法则(LIE)

.big-left[
`\(E_X\!\bigg(\mathop{E}\left[ \color{#6A5ACD}{{Y}_{i}} \mid {X}_{i},\, \color{#e64173}{s_i = 12} \right] -  \mathop{E}\left[ \color{#6A5ACD}{{Y}_{i}} \mid {X}_{i},\, \color{#e64173}{s_i = 11} \right] \bigg)\)`
]
.big-left[
`\(=E_X\! \bigg( \mathop{E}\left[ f_i(\color{#e64173}{12}) - f_i(\color{#e64173}{11}) \mid {X}_{i}\right] \bigg)\)`
]
.big-left[
`\(=\mathop{E}\left[ f_i(\color{#e64173}{12}) - f_i(\color{#e64173}{11}) \right]\)` .grey-light[(迭代期望)]
]
---
### 理论、总体分布与样本

&lt;br&gt;
&lt;img src="./figs/BigPictureC2D.png"&gt;

---
### 基于RCT理念的LPF得到因果效应还需要CIA 

- RCT的研究设计 → LPF（总体）→ 能够得到因果效应么？→ CIA
- 别忽略**线性CEF**的假设！
- **LPF模型设置的假设**：线性、**同质的**的LPF可以刻画**线性CEF**：
$$
`\begin{align}
  f_i(\color{#e64173}{s}) = \alpha + \tau \color{#e64173}{s} + \eta_i \tag{A}
\end{align}`
$$
  - 为什么 `\((\text{A})\)` 式是LPF？ → 个体 `\(i\)` 在 `\(\color{#e64173}{s}\)` 的任意取值下潜在收入， 而不是依据 `\(\color{#e64173}{s_i}\)` 观测值，所以省略了 `\(\color{#e64173}{s}\)` 的下标 `\(i\)` 
  - `\((\text{A})\)` 假设在 `\(f_i(\color{#e64173}{s})\)` 中唯一因人而异的部分是干扰项 `\(\eta_{i}\)` 的无条件均值为 0 (回想CEF) 用以捕捉决定潜在收入水平 `\(f_i(\color{#e64173}{s})\)` 的其他不可观测因素。将观察到的 `\(\color{#e64173}{s_i}\)` 和观察值 `\(\color{#6A5ACD}{{Y}_{i}}\)`  代入模型，就得到了**可回归的模型**:

$$
`\begin{align}
  \color{#6A5ACD}{{Y}_{i}} = \alpha + \tau \color{#e64173}{s_i} + \eta_i \tag{B}
\end{align}`
$$
-  `\((\text{A})\)` 式中 `\(\tau\)` 是**真实处置效应**，而 `\((\text{B})\)` 式 `\(\tau\)` 的 **样本估计值** `\(\hat\tau\)` 通常会因为 `\(s_i\)` 的**样本选择问题**产生偏误
- 文章的**研究设计**中说明如何能得到真实处置效应(内生性问题必须说明)

---
### 基于RCT理念的LPF得到因果效应还需要CIA 

- CIA下，意味着加入多个**可观察**的协变量 `\(X_{i}\)` ， 能够排除潜在的**干扰因素**
- 将潜在收入 `\(f_i(\color{#e64173}{s})\)` 的干扰项结构化为**可观察因素** `\(X_{i}\)` (因人而异)和**残差项** `\(v_{i}\)` 的线性函数：

$$
`\begin{align}
  \eta_i = {X}_{i}'\beta + \nu_i \tag{C}
\end{align}`
$$

-  `\(\beta\)` 是 `\(\eta_i\)` 对 `\({X}_{i}\)` 回归的**总体系数向量**(意味着可以通过最小二乘估计获得正确的系数估计)，所以有：

1.  `\(\mathop{E}\left[ \eta_i \mid {X}_{i} \right] = {X}_{i}'\beta\)` 
1. 残差项 `\(v_{i}\)` 与 `\(X_{i}\)` 不相关

---
### 基于RCT理念的LPF得到因果效应还需要CIA 

根据CIA可以得到：

.big-left[
`\(\mathop{E}\left[ f_i(\color{#e64173}{s}) \mid {X}_{i},\, \color{#e64173}{s_i} \right]\)`
]
.big-left[
`\(=\mathop{E}\left[ f_i(\color{#e64173}{s}) \mid {X}_{i} \right]\)` .grey-light[(根据CIA)]
]
.big-left[
`\(=\mathop{E}\left[ \alpha + \tau \color{#e64173}{s_i} + \eta_i \mid {X}_{i} \right]\)` .grey-light[(代入B式)]
]
.big-left[
`\(=\alpha + \tau \color{#e64173}{s_i} + \mathop{E}\left[ \eta_i \mid {X}_{i} \right]\)`
]
.big-left[
`\(=\alpha + \tau \color{#e64173}{s_i} + {X}_{i}'\beta\)` .grey-light[(最小二乘回归方程)]
]

- .hi-pink[回忆] 这里再次使用到，若 `\(f_i(\color{#e64173}{s})\)` 所代表的CEF是线性的(倒数第2行)，则意味着"**正确地模型设定为LPF**.super[.pink[†]]" 可以正确代表线性CEF


.footnote[
.pink[†] 这里"正确"是指若控制了 `\({X}_{i}\)` 就像RCT一样。
]

---
### 基于RCT理念的LPF得到因果效应还需要CIA 

所以把**可回归的模型**形式设定如下： 
$$
`\begin{align}
  {Y}_{i} = \alpha + \tau \color{#e64173}{s_i} + {X}_{i}'\beta + \nu_i
\end{align}`
$$

- 通过假设，限制扰动项 `\(\nu_i\)` 来估计**真正的因果效应** `\(\tau\)`
1. `\(\color{#e64173}{s_i}\)` (根据 CIA)
2. `\({X}_{i}\)` (根据定义 `\(\beta\)` 是 `\(\eta\)` 对 `\({X}_{i}\)` 回归的总体系数向量)

---
class: title-slide-section,inverse, middle
# 从观测样本到因果模型&lt;br&gt; → 必须排除的偏误

---

### 理论、总体分布与样本

&lt;br&gt;

&lt;img src="./figs/BigPictureD2C.png"&gt;

---
### 理解"朴素"估计值与LPF.super[ols]的关系

.hi-pink[回忆："朴素"估计量是干预组与控制组的观测结果均值之差] `\(E[Y_{i}|D_{i}=1]-E[Y_{i}|D_{i}=0]\)`

当干预变量为二值时，可以证明回归系数 `\(\hat\tau_{{OLS}}\)` 等于处理组与控制组样本均值之差(by Mixtape)。在样本视角下：
`$$\hat\tau_{{OLS}} = \frac{1}{N_{T}} \sum_{i=1}^{n}\left(y_{i} \mid d_{i}=1\right)-\frac{1}{N_{C}} \sum_{i=1}^{n}\left(y_{i} \mid d_{i}=0\right) = \bar{Y}_{T}-\bar{Y}_{C}$$`
在大样本下:
`$$\hat\tau_{{OLS}} = \bar{Y}_{T}-\bar{Y}_{C} \stackrel{p}{\longrightarrow} E\left[Y_{i} \mid D_{i}=1\right]-E\left[Y_{i} \mid D_{i}=0\right]=\tau_{{OLS}}$$`
- 综上, `\(\hat\tau_{{OLS}} = \bar{Y}_{T}-\bar{Y}_{C} \stackrel{p}{\longrightarrow}\tau_{{OLS}} = “朴素”估计量\)`  

.bb["朴素"估计量 .mono[=] ATE + 选择偏误 +异质性干预偏误]
 &lt;br&gt; &lt;p&gt;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;&amp;nbsp;
↑ 基于SUTVA假设可以使第三项为0&lt;/p&gt;

---

### "朴素"估计值 + 控制变量 + CIA .mono[-&gt;] 因果效应

现在我们已经知道在：
`\({E}\left[Y_{i}(0) \mid D_{i}=1\right] \neq {E}\left[Y_{i}(0) \mid D_{i}=0\right]\)` 时, 无法识别处置效应。

假如造成差异的原因: 个体未干预时的潜在结果 `\(Y_i(0)\)`  是可观测特征和不可观测特征的线性函数
`$$Y_{i}(0)=\alpha+\beta X_{i}+e_{i}$$` 
代入方程:  `\({Y}_{{i}}=\underbrace{{E}\left[{Y}_{{i}}(0)\right]}_{a}+\underbrace{\left[Y_{i}(1)-Y_{i}(0)\right] \times {D}_{i}}_{\tau}+\underbrace{Y_{i}(0)-{E}\left[Y_{i}(0)\right]}_{u_{i}}\)`

得: `\(Y_{i}=\alpha+\tau D_{i}+\beta X_{i}+e_{i}\)`  （观测结果、干预状态、可观测特征、不可观测特征的关系）

将 `\(Y_{i}\)` 对 `\(D_{i} 、 X_{i}\)` 归回: `\({E}\left({Y}_{{i}} \mid {D}_{{i}}, {X}_{{i}}\right)=\alpha+\ D_{i}+\beta X_{i}+{E}\left[e_{i} \mid {D}_{{i}}, {X}_{{i}}\right]\)`

---
### "朴素"估计值+控制变量+假设 .mono[-&gt;] LPF.super[ols] .mono[-&gt;] 有因果理论支撑的线性CEF

- 与CIA思路一样，若要使得条件期望函数的 `\(D_i\)` 的系数等于 `\(\tau\)` ,需要以观测结果、干预状态、可观测特征为基础的LPF的干扰项 `\(e_i\)` 的条件均值独立于干预变量：

  `\(E[e_i \mid D_i,X_i] = E[e_i \mid X_i]\)` 

- 可证明：**(建立在LPF.super[ols]基础上的)干扰项条件均值独立于干预变量**和 **平均未干预潜在结果条件独立**（ `\(E\left[Y_{i}(0) \mid D_{i}=1\right] = E\left[Y_{i}(0) \mid D_{i}=0\right]\)`  ）是等价的

- 这个条件使得LPF.super[ols]可以通过加入控制变量X 来达到估计处置变量D的真实因果效应系数 `\(\tau\)` 的目的

- **CMI** 与 **CIA** 是直接建立在 **潜在结果**上的；**干扰项条件均值独立于干预变量** 和 **平均潜在结果条件独立** 是建立在**平均潜在结果**基础上（是在CEF-LPF 框架下能够识别处置效应的关键条件）

---
### SUTVA 

- 在之前的例子中，都是假设个体处置效应是相同的，即 `\(\tau_i= \tau\)`
- **稳定个体干预值假设（The Stable Unit Treatment Value Assumption， SUTVA）**:简单说，每个个体的潜在结果不依赖于其他个体的干预状态。有两层含义：1. 不同个体的潜在结果之间不会有交互影响。2. 干预水平对所有个体都是相同的
- 第1个含义：它排除了**外部性**或**整体均衡效应**
    - 例：研究班级规模对个体学习效果的影响，同学之间往往存在外部性，如果班级里好学生多，相互讨论、相互促进，产生正外部性，从而提高了整体学习效率
    - 例：如果劳动力培训项目规模很大，改变整改市场技能结构，使得技能劳动力供给很多，则接受培训的个体干预效果就不显著。
- 第2层含义：处置效应对所有个体相同
    - 例如：教育对个人收入影响。要求纳入的教育程度要求教育质量相同

    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script src="https://platform.twitter.com/widgets.js"></script>
<script>var slideshow = remark.create({
"highlightStyle": "github",
"highlightLines": true,
"countIncrementalSlides": true,
"ratio": "16:10.85"
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();
// add `data-at-shortcutkeys` attribute to <body> to resolve conflicts with JAWS
// screen reader (see PR #262)
(function(d) {
  let res = {};
  d.querySelectorAll('.remark-help-content table tr').forEach(tr => {
    const t = tr.querySelector('td:nth-child(2)').innerText;
    tr.querySelectorAll('td:first-child .key').forEach(key => {
      const k = key.innerText;
      if (/^[a-z]$/.test(k)) res[k] = t;  // must be a single letter (key)
    });
  });
  d.body.setAttribute('data-at-shortcutkeys', JSON.stringify(res));
})(document);
(function() {
  "use strict"
  // Replace <script> tags in slides area to make them executable
  var scripts = document.querySelectorAll(
    '.remark-slides-area .remark-slide-container script'
  );
  if (!scripts.length) return;
  for (var i = 0; i < scripts.length; i++) {
    var s = document.createElement('script');
    var code = document.createTextNode(scripts[i].textContent);
    s.appendChild(code);
    var scriptAttrs = scripts[i].attributes;
    for (var j = 0; j < scriptAttrs.length; j++) {
      s.setAttribute(scriptAttrs[j].name, scriptAttrs[j].value);
    }
    scripts[i].parentElement.replaceChild(s, scripts[i]);
  }
})();
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();
// adds .remark-code-has-line-highlighted class to <pre> parent elements
// of code chunks containing highlighted lines with class .remark-code-line-highlighted
(function(d) {
  const hlines = d.querySelectorAll('.remark-code-line-highlighted');
  const preParents = [];
  const findPreParent = function(line, p = 0) {
    if (p > 1) return null; // traverse up no further than grandparent
    const el = line.parentElement;
    return el.tagName === "PRE" ? el : findPreParent(el, ++p);
  };

  for (let line of hlines) {
    let pre = findPreParent(line);
    if (pre && !preParents.includes(pre)) preParents.push(pre);
  }
  preParents.forEach(p => p.classList.add("remark-code-has-line-highlighted"));
})(document);</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
